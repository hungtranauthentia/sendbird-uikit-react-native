{"version":3,"names":["REQ_PER_TIMEOUT","TIMEOUT_MILLS","SAFE_TIMEOUT_BUFFER","generateRandomId","Math","random","toString","slice","BufferedRequest","updateMarkAsReadOptions","reqPerTimeout","timeoutMills","markAsRead","create","updateMarkAsDeliveredOptions","markAsDelivered","value","arguments","length","undefined","waitQueue","Map","nextQueue","state","timeout","push","func","lane","set","invoke","shift","size","nextRemains","min","lanes","keys","n","get","delete","handleIdle","handleProcessing","setTimeout","index","nextRequestBaseTimeout","forEach","clear","_defineProperty"],"sources":["bufferedRequest.ts"],"sourcesContent":["type Func = (...args: unknown[]) => Promise<unknown>;\ntype State = 'idle' | 'processing';\n\nlet REQ_PER_TIMEOUT = 5;\nlet TIMEOUT_MILLS = 1000;\nconst SAFE_TIMEOUT_BUFFER = 100;\n\nfunction generateRandomId() {\n  return Math.random().toString(16).slice(2);\n}\n\nexport class BufferedRequest {\n  public static markAsRead = BufferedRequest.create();\n  public static markAsDelivered = BufferedRequest.create();\n\n  public static updateMarkAsReadOptions(reqPerTimeout: number, timeoutMills: number) {\n    BufferedRequest.markAsRead = BufferedRequest.create(reqPerTimeout, timeoutMills);\n  }\n  public static updateMarkAsDeliveredOptions(reqPerTimeout: number, timeoutMills: number) {\n    BufferedRequest.markAsDelivered = BufferedRequest.create(reqPerTimeout, timeoutMills);\n  }\n\n  public static get reqPerTimeout() {\n    return REQ_PER_TIMEOUT;\n  }\n  public static set reqPerTimeout(value: number) {\n    REQ_PER_TIMEOUT = value;\n    BufferedRequest.markAsRead = BufferedRequest.create();\n    BufferedRequest.markAsDelivered = BufferedRequest.create();\n  }\n\n  public static get timeoutMills() {\n    return TIMEOUT_MILLS;\n  }\n  public static set timeoutMills(value: number) {\n    TIMEOUT_MILLS = value;\n    BufferedRequest.markAsRead = BufferedRequest.create();\n    BufferedRequest.markAsDelivered = BufferedRequest.create();\n  }\n\n  public static create(reqPerTimeout = REQ_PER_TIMEOUT, timeoutMills = TIMEOUT_MILLS) {\n    const waitQueue = new Map<string, Func>();\n    const nextQueue = new Map<string, Func>();\n\n    let state: State = 'idle';\n    let timeout: NodeJS.Timeout | undefined;\n\n    return {\n      push(func: Func, lane?: string) {\n        waitQueue.set(lane ?? generateRandomId(), func);\n        this.invoke();\n      },\n      shift() {\n        if (nextQueue.size < reqPerTimeout) {\n          const nextRemains = Math.min(reqPerTimeout - nextQueue.size, waitQueue.size);\n          const lanes = [...waitQueue.keys()];\n          for (let n = 0; n < nextRemains; n++) {\n            const lane = lanes[n];\n            const func = waitQueue.get(lane);\n            if (func) {\n              waitQueue.delete(lane);\n              nextQueue.set(lane, func);\n            }\n          }\n        }\n      },\n      handleIdle() {\n        if (0 < nextQueue.size) {\n          state = 'processing';\n          this.invoke();\n        }\n      },\n      handleProcessing() {\n        if (timeout) return;\n\n        timeout = setTimeout(() => {\n          timeout = undefined;\n          if (0 < nextQueue.size || 0 < waitQueue.size) {\n            this.invoke();\n          } else {\n            state = 'idle';\n          }\n        }, timeoutMills + SAFE_TIMEOUT_BUFFER);\n\n        let index = 0;\n        const nextRequestBaseTimeout = timeoutMills / nextQueue.size;\n        nextQueue.forEach((func) => {\n          setTimeout(() => {\n            func();\n            // TODO: Add retry\n            //.catch(() => waitQueue.set(lane, func));\n          }, nextRequestBaseTimeout * index);\n          index++;\n        });\n        nextQueue.clear();\n      },\n      async invoke() {\n        this.shift();\n\n        if (state === 'idle') {\n          this.handleIdle();\n        }\n\n        if (state === 'processing') {\n          this.handleProcessing();\n        }\n      },\n    };\n  }\n}\n"],"mappings":"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"}