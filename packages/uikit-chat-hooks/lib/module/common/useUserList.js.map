{"version":3,"names":["useMemo","useRef","useState","Logger","SBErrorCode","SBErrorMessage","useAsyncEffect","useFreshCallback","createUserQuery","sdk","queryCreator","createApplicationUserListQuery","useUserList","options","query","error","setError","loading","setLoading","refreshing","setRefreshing","users","setUsers","sortedUsers","sortComparator","sort","upsertUser","user","_ref","draft","userIdx","findIndex","it","userId","push","deleteUser","_ref2","splice","updateUsers","clearPrev","prev","concat","init","_query$current","current","hasNext","_query$current2","next","catch","e","code","UNAUTHORIZED_REQUEST","warn","ACL","refresh","_query$current3","nextUsers"],"sources":["useUserList.ts"],"sourcesContent":["import { useMemo, useRef, useState } from 'react';\n\nimport type { Optional, SendbirdChatSDK, SendbirdUser, UserStruct } from '@sendbird/uikit-utils';\nimport { Logger, SBErrorCode, SBErrorMessage, useAsyncEffect, useFreshCallback } from '@sendbird/uikit-utils';\n\nimport type { CustomQueryInterface, UseUserListOptions, UseUserListReturn } from '../types';\n\nconst createUserQuery = <User extends UserStruct>(\n  sdk: SendbirdChatSDK,\n  queryCreator?: UseUserListOptions<User>['queryCreator'],\n) => {\n  if (queryCreator) return queryCreator();\n  // In order to use the API, the option must be turned on in the dashboard.\n  return sdk.createApplicationUserListQuery() as unknown as CustomQueryInterface<User>;\n};\n\n/**\n * Get user list from query.\n * default query uses 'instance.createApplicationUserListQuery'\n * The response type of hook is depends on return type of 'query.next()'\n *\n * You can call hook with your custom query using {@link CustomQuery}\n * Or you can create your 'CustomQueryClass' implemented {@link CustomQueryInterface}'\n *\n * ```example\n *  const { users } = useUserList(sdk, {\n *    queryCreator: () => {\n *      const friendQuery = sdk.createFriendListQuery();\n *      return new CustomQuery({\n *        next: () => friendQuery.next(),\n *        isLoading: () => friendQuery.isLoading,\n *        hasNext: () => friendQuery.hasMore,\n *      });\n *    }\n *  })\n * ```\n * */\nexport const useUserList = <\n  Options extends UseUserListOptions<UserStruct>,\n  QueriedUser extends UserStruct = Options['queryCreator'] extends Optional<\n    () => CustomQueryInterface<infer User extends UserStruct>\n  >\n    ? User\n    : SendbirdUser,\n>(\n  sdk: SendbirdChatSDK,\n  options?: UseUserListOptions<QueriedUser>,\n): UseUserListReturn<QueriedUser> => {\n  const query = useRef<CustomQueryInterface<QueriedUser>>();\n\n  const [error, setError] = useState<unknown>(null);\n  const [loading, setLoading] = useState(false);\n  const [refreshing, setRefreshing] = useState(false);\n\n  const [users, setUsers] = useState<QueriedUser[]>([]);\n  const sortedUsers = useMemo((): QueriedUser[] => {\n    if (options?.sortComparator) return users.sort(options.sortComparator);\n    return users;\n  }, [users, options?.sortComparator]);\n\n  const upsertUser = useFreshCallback((user: QueriedUser) => {\n    setUsers(([...draft]) => {\n      const userIdx = draft.findIndex((it) => it.userId === user.userId);\n      if (userIdx > -1) draft[userIdx] = user;\n      else draft.push(user);\n      return draft;\n    });\n  });\n\n  const deleteUser = useFreshCallback((userId: QueriedUser['userId']) => {\n    setUsers(([...draft]) => {\n      const userIdx = draft.findIndex((it) => it.userId === userId);\n      if (userIdx > -1) draft.splice(userIdx, 1);\n      return draft;\n    });\n  });\n\n  const updateUsers = (users: QueriedUser[], clearPrev: boolean) => {\n    if (clearPrev) setUsers(users);\n    else setUsers((prev) => prev.concat(users));\n  };\n\n  const init = useFreshCallback(async () => {\n    query.current = createUserQuery<QueriedUser>(sdk, options?.queryCreator);\n    if (query.current?.hasNext) {\n      const users = await query.current?.next().catch((e) => {\n        Logger.error(e);\n        if (e.code === SBErrorCode.UNAUTHORIZED_REQUEST) Logger.warn(SBErrorMessage.ACL);\n        throw e;\n      });\n      updateUsers(users, true);\n    }\n  });\n\n  useAsyncEffect(async () => {\n    setLoading(true);\n    setError(null);\n    try {\n      await init();\n    } catch (e) {\n      setError(e);\n      setUsers([]);\n    } finally {\n      setLoading(false);\n    }\n  }, []);\n\n  const refresh = useFreshCallback(async () => {\n    setRefreshing(true);\n    setError(null);\n    try {\n      await init();\n    } catch (e) {\n      setError(e);\n      setUsers([]);\n    } finally {\n      setRefreshing(false);\n    }\n  });\n\n  const next = useFreshCallback(async () => {\n    if (query.current && query.current?.hasNext) {\n      const nextUsers = await query.current.next().catch((e) => {\n        Logger.error(e);\n        if (e.code === SBErrorCode.UNAUTHORIZED_REQUEST) Logger.warn(SBErrorMessage.ACL);\n        throw e;\n      });\n      updateUsers(nextUsers, false);\n    }\n  });\n\n  return {\n    loading,\n    error,\n    users: sortedUsers,\n    upsertUser,\n    deleteUser,\n    next,\n    refreshing,\n    refresh,\n  };\n};\n"],"mappings":"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"}