{"version":3,"names":["useRef","ASYNC_NOOP","NOOP","isDifferentChannel","isMyMessage","useAsyncEffect","useForceUpdate","useFreshCallback","useUniqHandlerId","useChannelHandler","useConnectionHandler","useChannelMessagesReducer","createMessageQuery","channel","creator","createPreviousMessageListQuery","limit","reverse","useOpenChannelMessagesWithQuery","sdk","userId","options","queryRef","forceUpdate","handlerId","loading","refreshing","messages","newMessages","updateMessages","updateNewMessages","deleteNewMessages","deleteMessages","updateLoading","updateRefreshing","sortComparator","init","uid","_queryRef$current","_sdk$currentUser2","current","queryCreator","hasNext","_queryRef$current2","_sdk$currentUser","list","load","currentUser","channelUpdater","isOpenChannel","onReconnectSucceeded","_queryRef$current3","_queryRef$current4","_queryRef$current5","_queryRef$current6","_queryRef$current7","_queryRef$current8","_queryRef$current9","_queryRef$current10","_queryRef$current11","_queryRef$current12","_queryRef$current13","_queryRef$current14","_queryRef$current15","_queryRef$current16","_queryRef$current17","_queryRef$current18","_sdk$currentUser3","lastMessage","messageContext","updatedMessages","addedMessages","deletedMessageIds","changeLogsContext","hasMore","token","messageQueryContext","timestamp","createdAt","changelogsParams","replyType","includeMetaArray","includeReactions","includeThreadInfo","includeParentMessageInfo","changeLogsByTS","getMessageChangeLogsSinceTimestamp","push","changeLogsByToken","getMessageChangeLogsSinceToken","messageQueryParams","prevResultSize","nextResultSize","customTypesFilter","messageTypeFilter","senderUserIdsFilter","showSubchannelMessagesOnly","queriedMessages","getMessagesByTimestamp","length","unshift","_options$shouldCountN","shouldCountNewMessages","call","_sdk$currentUser4","onMessagesReceived","onMessageReceived","eventChannel","message","_sdk$currentUser5","_sdk$currentUser6","_options$shouldCountN2","_sdk$currentUser7","onMessageUpdated","_sdk$currentUser8","_sdk$currentUser9","onMessageDeleted","messageId","onChannelChanged","onChannelFrozen","onChannelUnfrozen","onChannelParticipantCountChanged","onChannelDeleted","channelUrl","type","url","_options$onChannelDel","onOperatorUpdated","onUserUnbanned","onUserMuted","onUserUnmuted","onUserBanned","bannedUser","_sdk$currentUser10","_options$onChannelDel2","enter","error","_options$onError","_options$onChannelDel3","onError","exit","catch","refresh","prev","_queryRef$current19","_queryRef$current20","_sdk$currentUser11","hasPrev","_queryRef$current21","next","sendUserMessage","params","onPending","Promise","resolve","reject","pendingMessage","isUserMessage","_sdk$currentUser12","onSucceeded","sentMessage","_sdk$currentUser13","onFailed","err","failedMessage","_sdk$currentUser14","sendFileMessage","isFileMessage","_sdk$currentUser15","_sdk$currentUser16","_sdk$currentUser17","updateUserMessage","_sdk$currentUser18","updatedMessage","updateFileMessage","_sdk$currentUser19","resendMessage","_sdk$currentUser20","resendUserMessage","resendFileMessage","deleteMessage","sendingStatus","reqId","resetNewMessages","_sdk$currentUser21"],"sources":["useOpenChannelMessagesWithQuery.ts"],"sourcesContent":["import { useRef } from 'react';\n\nimport { MessageListParams } from '@sendbird/chat/message';\nimport type {\n  SendbirdBaseChannel,\n  SendbirdBaseMessage,\n  SendbirdOpenChannel,\n  SendbirdPreviousMessageListQuery,\n} from '@sendbird/uikit-utils';\nimport {\n  ASYNC_NOOP,\n  NOOP,\n  isDifferentChannel,\n  isMyMessage,\n  useAsyncEffect,\n  useForceUpdate,\n  useFreshCallback,\n  useUniqHandlerId,\n} from '@sendbird/uikit-utils';\n\nimport { useChannelHandler } from '../../handler/useChannelHandler';\nimport { useConnectionHandler } from '../../handler/useConnectionHandler';\nimport type { UseOpenChannelMessages, UseOpenChannelMessagesOptions } from '../../types';\nimport { useChannelMessagesReducer } from '../useChannelMessagesReducer';\n\nconst createMessageQuery = (channel: SendbirdOpenChannel, creator?: UseOpenChannelMessagesOptions['queryCreator']) => {\n  if (creator) return creator();\n  return channel.createPreviousMessageListQuery({\n    limit: 100,\n    reverse: true,\n  });\n};\n\nexport const useOpenChannelMessagesWithQuery: UseOpenChannelMessages = (sdk, channel, userId, options) => {\n  const queryRef = useRef<SendbirdPreviousMessageListQuery>();\n  const forceUpdate = useForceUpdate();\n  const handlerId = useUniqHandlerId('useOpenChannelMessagesWithQuery');\n\n  const {\n    loading,\n    refreshing,\n    messages,\n    newMessages,\n    updateMessages,\n    updateNewMessages,\n    deleteNewMessages,\n    deleteMessages,\n    updateLoading,\n    updateRefreshing,\n  } = useChannelMessagesReducer(options?.sortComparator);\n\n  const init = useFreshCallback(async (uid?: string) => {\n    if (uid) {\n      queryRef.current = createMessageQuery(channel, options?.queryCreator);\n      if (queryRef.current?.hasNext) {\n        const list = await queryRef.current?.load();\n\n        updateMessages(list, true, sdk.currentUser?.userId);\n      }\n      updateNewMessages([], true, sdk.currentUser?.userId);\n    }\n  });\n\n  const channelUpdater = (channel: SendbirdBaseChannel) => {\n    if (channel.isOpenChannel() && !isDifferentChannel(channel, channel)) {\n      forceUpdate();\n    }\n  };\n\n  useConnectionHandler(sdk, handlerId, {\n    async onReconnectSucceeded() {\n      const lastMessage = messages[0];\n      if (!lastMessage) return;\n\n      const messageContext = {\n        updatedMessages: [] as SendbirdBaseMessage[],\n        addedMessages: [] as SendbirdBaseMessage[],\n        deletedMessageIds: [] as (number | string)[],\n      };\n      const changeLogsContext = {\n        hasMore: false,\n        token: '',\n      };\n      const messageQueryContext = {\n        hasMore: false,\n        timestamp: lastMessage.createdAt,\n      };\n\n      // Updated & Deleted messages\n      const changelogsParams = {\n        replyType: queryRef.current?.replyType,\n        includeMetaArray: queryRef.current?.includeMetaArray,\n        includeReactions: queryRef.current?.includeReactions,\n        includeThreadInfo: queryRef.current?.includeThreadInfo,\n        includeParentMessageInfo: queryRef.current?.includeParentMessageInfo,\n      };\n\n      const changeLogsByTS = await channel.getMessageChangeLogsSinceTimestamp(lastMessage.createdAt);\n      changeLogsContext.token = changeLogsByTS.token;\n      changeLogsContext.hasMore = changeLogsByTS.hasMore;\n      messageContext.updatedMessages.push(...changeLogsByTS.updatedMessages);\n      messageContext.deletedMessageIds.push(...changeLogsByTS.deletedMessageIds);\n\n      while (changeLogsContext.hasMore) {\n        const changeLogsByToken = await channel.getMessageChangeLogsSinceToken(changeLogsByTS.token, changelogsParams);\n        changeLogsContext.token = changeLogsByToken.token;\n        changeLogsContext.hasMore = changeLogsByToken.hasMore;\n        messageContext.updatedMessages.push(...changeLogsByToken.updatedMessages);\n        messageContext.deletedMessageIds.push(...changeLogsByToken.deletedMessageIds);\n      }\n\n      // Added messages\n      const messageQueryParams: MessageListParams = {\n        prevResultSize: 0,\n        nextResultSize: queryRef.current?.limit ?? 100,\n        reverse: queryRef.current?.reverse,\n        includeParentMessageInfo: queryRef.current?.includeParentMessageInfo,\n        includeThreadInfo: queryRef.current?.includeThreadInfo,\n        includeReactions: queryRef.current?.includeReactions,\n        includeMetaArray: queryRef.current?.includeMetaArray,\n        replyType: queryRef.current?.replyType,\n        customTypesFilter: queryRef.current?.customTypesFilter as never,\n        messageTypeFilter: queryRef.current?.messageTypeFilter,\n        senderUserIdsFilter: queryRef.current?.senderUserIdsFilter as never,\n        showSubchannelMessagesOnly: queryRef.current?.showSubchannelMessagesOnly,\n      };\n\n      const queriedMessages = await channel.getMessagesByTimestamp(lastMessage.createdAt, messageQueryParams);\n      messageQueryContext.hasMore = queriedMessages.length > 0;\n      if (messageQueryContext.hasMore) {\n        messageQueryContext.timestamp = queriedMessages[0].createdAt;\n        messageContext.addedMessages.unshift(...queriedMessages);\n      }\n\n      while (messageQueryContext.hasMore) {\n        const queriedMessages = await channel.getMessagesByTimestamp(messageQueryContext.timestamp, messageQueryParams);\n        messageQueryContext.hasMore = queriedMessages.length > 0;\n        if (messageQueryContext.hasMore) {\n          messageQueryContext.timestamp = queriedMessages[0].createdAt;\n          messageContext.addedMessages.unshift(...queriedMessages);\n        }\n      }\n\n      // Update to View\n      updateMessages(\n        [...messageContext.addedMessages, ...messageContext.updatedMessages],\n        false,\n        sdk.currentUser?.userId,\n      );\n      deleteMessages(messageContext.deletedMessageIds, []);\n\n      if (messageContext.addedMessages.length > 0) {\n        if (options?.shouldCountNewMessages?.()) {\n          updateNewMessages(messageContext.addedMessages, false, sdk.currentUser?.userId);\n        }\n        if (options?.onMessagesReceived) {\n          options.onMessagesReceived(messageContext.addedMessages);\n        }\n      }\n    },\n  });\n\n  useChannelHandler(\n    sdk,\n    handlerId,\n    {\n      // Messages\n      onMessageReceived(eventChannel, message) {\n        if (isDifferentChannel(channel, eventChannel)) return;\n        if (isMyMessage(message, sdk.currentUser?.userId)) return;\n\n        updateMessages([message], false, sdk.currentUser?.userId);\n        if (options?.shouldCountNewMessages?.()) {\n          updateNewMessages([message], false, sdk.currentUser?.userId);\n        }\n        if (options?.onMessagesReceived) {\n          options.onMessagesReceived([message]);\n        }\n      },\n      onMessageUpdated(eventChannel, message) {\n        if (isDifferentChannel(channel, eventChannel)) return;\n        if (isMyMessage(message, sdk.currentUser?.userId)) return;\n\n        updateMessages([message], false, sdk.currentUser?.userId);\n      },\n      onMessageDeleted(eventChannel, messageId) {\n        if (isDifferentChannel(channel, eventChannel)) return;\n        deleteMessages([messageId], []);\n        deleteNewMessages([messageId], []);\n      },\n      // Channels\n      onChannelChanged: channelUpdater,\n      onChannelFrozen: channelUpdater,\n      onChannelUnfrozen: channelUpdater,\n      onChannelParticipantCountChanged(eventChannel) {\n        if (isDifferentChannel(channel, eventChannel)) return;\n        channelUpdater(eventChannel);\n      },\n      onChannelDeleted(channelUrl, type) {\n        if (channel.url === channelUrl && type === 'open') {\n          options?.onChannelDeleted?.();\n        }\n      },\n      // Users\n      onOperatorUpdated: channelUpdater,\n      onUserUnbanned: channelUpdater,\n      onUserMuted: channelUpdater,\n      onUserUnmuted: channelUpdater,\n      onUserBanned(eventChannel, bannedUser) {\n        if (isDifferentChannel(channel, eventChannel)) return;\n\n        if (bannedUser.userId === sdk.currentUser?.userId) {\n          options?.onChannelDeleted?.();\n        } else {\n          channelUpdater(eventChannel);\n        }\n      },\n    },\n    'open',\n  );\n\n  useAsyncEffect(async () => {\n    updateLoading(true);\n\n    try {\n      await channel.enter();\n      await init(userId);\n    } catch (error) {\n      options?.onError?.(error);\n      options?.onChannelDeleted?.();\n    } finally {\n      updateLoading(false);\n    }\n\n    return () => {\n      channel.exit().catch(NOOP);\n    };\n  }, [channel.url, userId]);\n\n  const refresh: ReturnType<UseOpenChannelMessages>['refresh'] = useFreshCallback(async () => {\n    updateRefreshing(true);\n    await init(userId);\n    updateRefreshing(false);\n  });\n\n  const prev: ReturnType<UseOpenChannelMessages>['prev'] = useFreshCallback(async () => {\n    if (queryRef.current && queryRef.current?.hasNext) {\n      const list = await queryRef.current?.load();\n      updateMessages(list, false, sdk.currentUser?.userId);\n    }\n  });\n  const hasPrev: ReturnType<UseOpenChannelMessages>['hasPrev'] = useFreshCallback(\n    () => queryRef.current?.hasNext ?? false,\n  );\n\n  const next: ReturnType<UseOpenChannelMessages>['next'] = useFreshCallback(ASYNC_NOOP);\n  const hasNext: ReturnType<UseOpenChannelMessages>['hasNext'] = useFreshCallback(() => false);\n\n  const sendUserMessage: ReturnType<UseOpenChannelMessages>['sendUserMessage'] = useFreshCallback(\n    (params, onPending) => {\n      return new Promise((resolve, reject) => {\n        channel\n          .sendUserMessage(params)\n          .onPending((pendingMessage) => {\n            if (pendingMessage.isUserMessage()) {\n              updateMessages([pendingMessage], false, sdk.currentUser?.userId);\n              onPending?.(pendingMessage);\n            }\n          })\n          .onSucceeded((sentMessage) => {\n            if (sentMessage.isUserMessage()) {\n              updateMessages([sentMessage], false, sdk.currentUser?.userId);\n              resolve(sentMessage);\n            }\n          })\n          .onFailed((err, failedMessage) => {\n            if (failedMessage) {\n              updateMessages([failedMessage], false, sdk.currentUser?.userId);\n            }\n            reject(err);\n          });\n      });\n    },\n  );\n\n  const sendFileMessage: ReturnType<UseOpenChannelMessages>['sendFileMessage'] = useFreshCallback(\n    (params, onPending) => {\n      return new Promise((resolve, reject) => {\n        channel\n          .sendFileMessage(params)\n          .onPending((pendingMessage) => {\n            if (pendingMessage.isFileMessage()) {\n              updateMessages([pendingMessage], false, sdk.currentUser?.userId);\n              onPending?.(pendingMessage);\n            }\n          })\n          .onSucceeded((sentMessage) => {\n            if (sentMessage.isFileMessage()) {\n              updateMessages([sentMessage], false, sdk.currentUser?.userId);\n              resolve(sentMessage);\n            }\n          })\n          .onFailed((err, failedMessage) => {\n            if (failedMessage) {\n              updateMessages([failedMessage], false, sdk.currentUser?.userId);\n            }\n            reject(err);\n          });\n      });\n    },\n  );\n\n  const updateUserMessage: ReturnType<UseOpenChannelMessages>['updateUserMessage'] = useFreshCallback(\n    async (messageId, params) => {\n      const updatedMessage = await channel.updateUserMessage(messageId, params);\n      updateMessages([updatedMessage], false, sdk.currentUser?.userId);\n      return updatedMessage;\n    },\n  );\n  const updateFileMessage: ReturnType<UseOpenChannelMessages>['updateFileMessage'] = useFreshCallback(\n    async (messageId, params) => {\n      const updatedMessage = await channel.updateFileMessage(messageId, params);\n      updateMessages([updatedMessage], false, sdk.currentUser?.userId);\n      return updatedMessage;\n    },\n  );\n  const resendMessage: ReturnType<UseOpenChannelMessages>['resendMessage'] = useFreshCallback(async (failedMessage) => {\n    const message = await (() => {\n      if (failedMessage.isUserMessage()) return channel.resendUserMessage(failedMessage);\n      if (failedMessage.isFileMessage()) return channel.resendFileMessage(failedMessage);\n      return null;\n    })();\n\n    if (message) updateMessages([message], false, sdk.currentUser?.userId);\n  });\n  const deleteMessage: ReturnType<UseOpenChannelMessages>['deleteMessage'] = useFreshCallback(async (message) => {\n    if (message.sendingStatus === 'succeeded') {\n      if (message.isUserMessage()) await channel.deleteMessage(message);\n      if (message.isFileMessage()) await channel.deleteMessage(message);\n    } else {\n      deleteMessages([message.messageId], [message.reqId]);\n    }\n  });\n  const resetNewMessages: ReturnType<UseOpenChannelMessages>['resetNewMessages'] = useFreshCallback(() => {\n    updateNewMessages([], true, sdk.currentUser?.userId);\n  });\n\n  return {\n    loading,\n    refreshing,\n    refresh,\n    messages,\n    newMessages,\n    next,\n    hasNext,\n    prev,\n    hasPrev,\n    sendUserMessage,\n    sendFileMessage,\n    updateUserMessage,\n    updateFileMessage,\n    resendMessage,\n    deleteMessage,\n    resetNewMessages,\n  };\n};\n"],"mappings":"AAAA,SAASA,MAAM,QAAQ,OAAO;AAS9B,SACEC,UAAU,EACVC,IAAI,EACJC,kBAAkB,EAClBC,WAAW,EACXC,cAAc,EACdC,cAAc,EACdC,gBAAgB,EAChBC,gBAAgB,QACX,uBAAuB;AAE9B,SAASC,iBAAiB,QAAQ,iCAAiC;AACnE,SAASC,oBAAoB,QAAQ,oCAAoC;AAEzE,SAASC,yBAAyB,QAAQ,8BAA8B;AAExE,MAAMC,kBAAkB,GAAGA,CAACC,OAA4B,EAAEC,OAAuD,KAAK;EACpH,IAAIA,OAAO,EAAE,OAAOA,OAAO,EAAE;EAC7B,OAAOD,OAAO,CAACE,8BAA8B,CAAC;IAC5CC,KAAK,EAAE,GAAG;IACVC,OAAO,EAAE;EACX,CAAC,CAAC;AACJ,CAAC;AAED,OAAO,MAAMC,+BAAuD,GAAGA,CAACC,GAAG,EAAEN,OAAO,EAAEO,MAAM,EAAEC,OAAO,KAAK;EACxG,MAAMC,QAAQ,GAAGtB,MAAM,EAAoC;EAC3D,MAAMuB,WAAW,GAAGjB,cAAc,EAAE;EACpC,MAAMkB,SAAS,GAAGhB,gBAAgB,CAAC,iCAAiC,CAAC;EAErE,MAAM;IACJiB,OAAO;IACPC,UAAU;IACVC,QAAQ;IACRC,WAAW;IACXC,cAAc;IACdC,iBAAiB;IACjBC,iBAAiB;IACjBC,cAAc;IACdC,aAAa;IACbC;EACF,CAAC,GAAGvB,yBAAyB,CAACU,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEc,cAAc,CAAC;EAEtD,MAAMC,IAAI,GAAG7B,gBAAgB,CAAC,MAAO8B,GAAY,IAAK;IACpD,IAAIA,GAAG,EAAE;MAAA,IAAAC,iBAAA,EAAAC,iBAAA;MACPjB,QAAQ,CAACkB,OAAO,GAAG5B,kBAAkB,CAACC,OAAO,EAAEQ,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEoB,YAAY,CAAC;MACrE,KAAAH,iBAAA,GAAIhB,QAAQ,CAACkB,OAAO,cAAAF,iBAAA,eAAhBA,iBAAA,CAAkBI,OAAO,EAAE;QAAA,IAAAC,kBAAA,EAAAC,gBAAA;QAC7B,MAAMC,IAAI,GAAG,QAAAF,kBAAA,GAAMrB,QAAQ,CAACkB,OAAO,cAAAG,kBAAA,uBAAhBA,kBAAA,CAAkBG,IAAI,EAAE;QAE3CjB,cAAc,CAACgB,IAAI,EAAE,IAAI,GAAAD,gBAAA,GAAEzB,GAAG,CAAC4B,WAAW,cAAAH,gBAAA,uBAAfA,gBAAA,CAAiBxB,MAAM,CAAC;MACrD;MACAU,iBAAiB,CAAC,EAAE,EAAE,IAAI,GAAAS,iBAAA,GAAEpB,GAAG,CAAC4B,WAAW,cAAAR,iBAAA,uBAAfA,iBAAA,CAAiBnB,MAAM,CAAC;IACtD;EACF,CAAC,CAAC;EAEF,MAAM4B,cAAc,GAAInC,OAA4B,IAAK;IACvD,IAAIA,OAAO,CAACoC,aAAa,EAAE,IAAI,CAAC9C,kBAAkB,CAACU,OAAO,EAAEA,OAAO,CAAC,EAAE;MACpEU,WAAW,EAAE;IACf;EACF,CAAC;EAEDb,oBAAoB,CAACS,GAAG,EAAEK,SAAS,EAAE;IACnC,MAAM0B,oBAAoBA,CAAA,EAAG;MAAA,IAAAC,kBAAA,EAAAC,kBAAA,EAAAC,kBAAA,EAAAC,kBAAA,EAAAC,kBAAA,EAAAC,kBAAA,EAAAC,kBAAA,EAAAC,mBAAA,EAAAC,mBAAA,EAAAC,mBAAA,EAAAC,mBAAA,EAAAC,mBAAA,EAAAC,mBAAA,EAAAC,mBAAA,EAAAC,mBAAA,EAAAC,mBAAA,EAAAC,iBAAA;MAC3B,MAAMC,WAAW,GAAGzC,QAAQ,CAAC,CAAC,CAAC;MAC/B,IAAI,CAACyC,WAAW,EAAE;MAElB,MAAMC,cAAc,GAAG;QACrBC,eAAe,EAAE,EAA2B;QAC5CC,aAAa,EAAE,EAA2B;QAC1CC,iBAAiB,EAAE;MACrB,CAAC;MACD,MAAMC,iBAAiB,GAAG;QACxBC,OAAO,EAAE,KAAK;QACdC,KAAK,EAAE;MACT,CAAC;MACD,MAAMC,mBAAmB,GAAG;QAC1BF,OAAO,EAAE,KAAK;QACdG,SAAS,EAAET,WAAW,CAACU;MACzB,CAAC;;MAED;MACA,MAAMC,gBAAgB,GAAG;QACvBC,SAAS,GAAA7B,kBAAA,GAAE7B,QAAQ,CAACkB,OAAO,cAAAW,kBAAA,uBAAhBA,kBAAA,CAAkB6B,SAAS;QACtCC,gBAAgB,GAAA7B,kBAAA,GAAE9B,QAAQ,CAACkB,OAAO,cAAAY,kBAAA,uBAAhBA,kBAAA,CAAkB6B,gBAAgB;QACpDC,gBAAgB,GAAA7B,kBAAA,GAAE/B,QAAQ,CAACkB,OAAO,cAAAa,kBAAA,uBAAhBA,kBAAA,CAAkB6B,gBAAgB;QACpDC,iBAAiB,GAAA7B,kBAAA,GAAEhC,QAAQ,CAACkB,OAAO,cAAAc,kBAAA,uBAAhBA,kBAAA,CAAkB6B,iBAAiB;QACtDC,wBAAwB,GAAA7B,kBAAA,GAAEjC,QAAQ,CAACkB,OAAO,cAAAe,kBAAA,uBAAhBA,kBAAA,CAAkB6B;MAC9C,CAAC;MAED,MAAMC,cAAc,GAAG,MAAMxE,OAAO,CAACyE,kCAAkC,CAAClB,WAAW,CAACU,SAAS,CAAC;MAC9FL,iBAAiB,CAACE,KAAK,GAAGU,cAAc,CAACV,KAAK;MAC9CF,iBAAiB,CAACC,OAAO,GAAGW,cAAc,CAACX,OAAO;MAClDL,cAAc,CAACC,eAAe,CAACiB,IAAI,CAAC,GAAGF,cAAc,CAACf,eAAe,CAAC;MACtED,cAAc,CAACG,iBAAiB,CAACe,IAAI,CAAC,GAAGF,cAAc,CAACb,iBAAiB,CAAC;MAE1E,OAAOC,iBAAiB,CAACC,OAAO,EAAE;QAChC,MAAMc,iBAAiB,GAAG,MAAM3E,OAAO,CAAC4E,8BAA8B,CAACJ,cAAc,CAACV,KAAK,EAAEI,gBAAgB,CAAC;QAC9GN,iBAAiB,CAACE,KAAK,GAAGa,iBAAiB,CAACb,KAAK;QACjDF,iBAAiB,CAACC,OAAO,GAAGc,iBAAiB,CAACd,OAAO;QACrDL,cAAc,CAACC,eAAe,CAACiB,IAAI,CAAC,GAAGC,iBAAiB,CAAClB,eAAe,CAAC;QACzED,cAAc,CAACG,iBAAiB,CAACe,IAAI,CAAC,GAAGC,iBAAiB,CAAChB,iBAAiB,CAAC;MAC/E;;MAEA;MACA,MAAMkB,kBAAqC,GAAG;QAC5CC,cAAc,EAAE,CAAC;QACjBC,cAAc,EAAE,EAAApC,kBAAA,GAAAlC,QAAQ,CAACkB,OAAO,cAAAgB,kBAAA,uBAAhBA,kBAAA,CAAkBxC,KAAK,KAAI,GAAG;QAC9CC,OAAO,GAAAwC,kBAAA,GAAEnC,QAAQ,CAACkB,OAAO,cAAAiB,kBAAA,uBAAhBA,kBAAA,CAAkBxC,OAAO;QAClCmE,wBAAwB,GAAA1B,mBAAA,GAAEpC,QAAQ,CAACkB,OAAO,cAAAkB,mBAAA,uBAAhBA,mBAAA,CAAkB0B,wBAAwB;QACpED,iBAAiB,GAAAxB,mBAAA,GAAErC,QAAQ,CAACkB,OAAO,cAAAmB,mBAAA,uBAAhBA,mBAAA,CAAkBwB,iBAAiB;QACtDD,gBAAgB,GAAAtB,mBAAA,GAAEtC,QAAQ,CAACkB,OAAO,cAAAoB,mBAAA,uBAAhBA,mBAAA,CAAkBsB,gBAAgB;QACpDD,gBAAgB,GAAApB,mBAAA,GAAEvC,QAAQ,CAACkB,OAAO,cAAAqB,mBAAA,uBAAhBA,mBAAA,CAAkBoB,gBAAgB;QACpDD,SAAS,GAAAlB,mBAAA,GAAExC,QAAQ,CAACkB,OAAO,cAAAsB,mBAAA,uBAAhBA,mBAAA,CAAkBkB,SAAS;QACtCa,iBAAiB,GAAA9B,mBAAA,GAAEzC,QAAQ,CAACkB,OAAO,cAAAuB,mBAAA,uBAAhBA,mBAAA,CAAkB8B,iBAA0B;QAC/DC,iBAAiB,GAAA9B,mBAAA,GAAE1C,QAAQ,CAACkB,OAAO,cAAAwB,mBAAA,uBAAhBA,mBAAA,CAAkB8B,iBAAiB;QACtDC,mBAAmB,GAAA9B,mBAAA,GAAE3C,QAAQ,CAACkB,OAAO,cAAAyB,mBAAA,uBAAhBA,mBAAA,CAAkB8B,mBAA4B;QACnEC,0BAA0B,GAAA9B,mBAAA,GAAE5C,QAAQ,CAACkB,OAAO,cAAA0B,mBAAA,uBAAhBA,mBAAA,CAAkB8B;MAChD,CAAC;MAED,MAAMC,eAAe,GAAG,MAAMpF,OAAO,CAACqF,sBAAsB,CAAC9B,WAAW,CAACU,SAAS,EAAEY,kBAAkB,CAAC;MACvGd,mBAAmB,CAACF,OAAO,GAAGuB,eAAe,CAACE,MAAM,GAAG,CAAC;MACxD,IAAIvB,mBAAmB,CAACF,OAAO,EAAE;QAC/BE,mBAAmB,CAACC,SAAS,GAAGoB,eAAe,CAAC,CAAC,CAAC,CAACnB,SAAS;QAC5DT,cAAc,CAACE,aAAa,CAAC6B,OAAO,CAAC,GAAGH,eAAe,CAAC;MAC1D;MAEA,OAAOrB,mBAAmB,CAACF,OAAO,EAAE;QAClC,MAAMuB,eAAe,GAAG,MAAMpF,OAAO,CAACqF,sBAAsB,CAACtB,mBAAmB,CAACC,SAAS,EAAEa,kBAAkB,CAAC;QAC/Gd,mBAAmB,CAACF,OAAO,GAAGuB,eAAe,CAACE,MAAM,GAAG,CAAC;QACxD,IAAIvB,mBAAmB,CAACF,OAAO,EAAE;UAC/BE,mBAAmB,CAACC,SAAS,GAAGoB,eAAe,CAAC,CAAC,CAAC,CAACnB,SAAS;UAC5DT,cAAc,CAACE,aAAa,CAAC6B,OAAO,CAAC,GAAGH,eAAe,CAAC;QAC1D;MACF;;MAEA;MACApE,cAAc,CACZ,CAAC,GAAGwC,cAAc,CAACE,aAAa,EAAE,GAAGF,cAAc,CAACC,eAAe,CAAC,EACpE,KAAK,GAAAH,iBAAA,GACLhD,GAAG,CAAC4B,WAAW,cAAAoB,iBAAA,uBAAfA,iBAAA,CAAiB/C,MAAM,CACxB;MACDY,cAAc,CAACqC,cAAc,CAACG,iBAAiB,EAAE,EAAE,CAAC;MAEpD,IAAIH,cAAc,CAACE,aAAa,CAAC4B,MAAM,GAAG,CAAC,EAAE;QAAA,IAAAE,qBAAA;QAC3C,IAAIhF,OAAO,aAAPA,OAAO,gBAAAgF,qBAAA,GAAPhF,OAAO,CAAEiF,sBAAsB,cAAAD,qBAAA,eAA/BA,qBAAA,CAAAE,IAAA,CAAAlF,OAAO,CAA4B,EAAE;UAAA,IAAAmF,iBAAA;UACvC1E,iBAAiB,CAACuC,cAAc,CAACE,aAAa,EAAE,KAAK,GAAAiC,iBAAA,GAAErF,GAAG,CAAC4B,WAAW,cAAAyD,iBAAA,uBAAfA,iBAAA,CAAiBpF,MAAM,CAAC;QACjF;QACA,IAAIC,OAAO,aAAPA,OAAO,eAAPA,OAAO,CAAEoF,kBAAkB,EAAE;UAC/BpF,OAAO,CAACoF,kBAAkB,CAACpC,cAAc,CAACE,aAAa,CAAC;QAC1D;MACF;IACF;EACF,CAAC,CAAC;EAEF9D,iBAAiB,CACfU,GAAG,EACHK,SAAS,EACT;IACE;IACAkF,iBAAiBA,CAACC,YAAY,EAAEC,OAAO,EAAE;MAAA,IAAAC,iBAAA,EAAAC,iBAAA,EAAAC,sBAAA;MACvC,IAAI5G,kBAAkB,CAACU,OAAO,EAAE8F,YAAY,CAAC,EAAE;MAC/C,IAAIvG,WAAW,CAACwG,OAAO,GAAAC,iBAAA,GAAE1F,GAAG,CAAC4B,WAAW,cAAA8D,iBAAA,uBAAfA,iBAAA,CAAiBzF,MAAM,CAAC,EAAE;MAEnDS,cAAc,CAAC,CAAC+E,OAAO,CAAC,EAAE,KAAK,GAAAE,iBAAA,GAAE3F,GAAG,CAAC4B,WAAW,cAAA+D,iBAAA,uBAAfA,iBAAA,CAAiB1F,MAAM,CAAC;MACzD,IAAIC,OAAO,aAAPA,OAAO,gBAAA0F,sBAAA,GAAP1F,OAAO,CAAEiF,sBAAsB,cAAAS,sBAAA,eAA/BA,sBAAA,CAAAR,IAAA,CAAAlF,OAAO,CAA4B,EAAE;QAAA,IAAA2F,iBAAA;QACvClF,iBAAiB,CAAC,CAAC8E,OAAO,CAAC,EAAE,KAAK,GAAAI,iBAAA,GAAE7F,GAAG,CAAC4B,WAAW,cAAAiE,iBAAA,uBAAfA,iBAAA,CAAiB5F,MAAM,CAAC;MAC9D;MACA,IAAIC,OAAO,aAAPA,OAAO,eAAPA,OAAO,CAAEoF,kBAAkB,EAAE;QAC/BpF,OAAO,CAACoF,kBAAkB,CAAC,CAACG,OAAO,CAAC,CAAC;MACvC;IACF,CAAC;IACDK,gBAAgBA,CAACN,YAAY,EAAEC,OAAO,EAAE;MAAA,IAAAM,iBAAA,EAAAC,iBAAA;MACtC,IAAIhH,kBAAkB,CAACU,OAAO,EAAE8F,YAAY,CAAC,EAAE;MAC/C,IAAIvG,WAAW,CAACwG,OAAO,GAAAM,iBAAA,GAAE/F,GAAG,CAAC4B,WAAW,cAAAmE,iBAAA,uBAAfA,iBAAA,CAAiB9F,MAAM,CAAC,EAAE;MAEnDS,cAAc,CAAC,CAAC+E,OAAO,CAAC,EAAE,KAAK,GAAAO,iBAAA,GAAEhG,GAAG,CAAC4B,WAAW,cAAAoE,iBAAA,uBAAfA,iBAAA,CAAiB/F,MAAM,CAAC;IAC3D,CAAC;IACDgG,gBAAgBA,CAACT,YAAY,EAAEU,SAAS,EAAE;MACxC,IAAIlH,kBAAkB,CAACU,OAAO,EAAE8F,YAAY,CAAC,EAAE;MAC/C3E,cAAc,CAAC,CAACqF,SAAS,CAAC,EAAE,EAAE,CAAC;MAC/BtF,iBAAiB,CAAC,CAACsF,SAAS,CAAC,EAAE,EAAE,CAAC;IACpC,CAAC;IACD;IACAC,gBAAgB,EAAEtE,cAAc;IAChCuE,eAAe,EAAEvE,cAAc;IAC/BwE,iBAAiB,EAAExE,cAAc;IACjCyE,gCAAgCA,CAACd,YAAY,EAAE;MAC7C,IAAIxG,kBAAkB,CAACU,OAAO,EAAE8F,YAAY,CAAC,EAAE;MAC/C3D,cAAc,CAAC2D,YAAY,CAAC;IAC9B,CAAC;IACDe,gBAAgBA,CAACC,UAAU,EAAEC,IAAI,EAAE;MACjC,IAAI/G,OAAO,CAACgH,GAAG,KAAKF,UAAU,IAAIC,IAAI,KAAK,MAAM,EAAE;QAAA,IAAAE,qBAAA;QACjDzG,OAAO,aAAPA,OAAO,wBAAAyG,qBAAA,GAAPzG,OAAO,CAAEqG,gBAAgB,cAAAI,qBAAA,uBAAzBA,qBAAA,CAAAvB,IAAA,CAAAlF,OAAO,CAAsB;MAC/B;IACF,CAAC;IACD;IACA0G,iBAAiB,EAAE/E,cAAc;IACjCgF,cAAc,EAAEhF,cAAc;IAC9BiF,WAAW,EAAEjF,cAAc;IAC3BkF,aAAa,EAAElF,cAAc;IAC7BmF,YAAYA,CAACxB,YAAY,EAAEyB,UAAU,EAAE;MAAA,IAAAC,kBAAA;MACrC,IAAIlI,kBAAkB,CAACU,OAAO,EAAE8F,YAAY,CAAC,EAAE;MAE/C,IAAIyB,UAAU,CAAChH,MAAM,OAAAiH,kBAAA,GAAKlH,GAAG,CAAC4B,WAAW,cAAAsF,kBAAA,uBAAfA,kBAAA,CAAiBjH,MAAM,GAAE;QAAA,IAAAkH,sBAAA;QACjDjH,OAAO,aAAPA,OAAO,wBAAAiH,sBAAA,GAAPjH,OAAO,CAAEqG,gBAAgB,cAAAY,sBAAA,uBAAzBA,sBAAA,CAAA/B,IAAA,CAAAlF,OAAO,CAAsB;MAC/B,CAAC,MAAM;QACL2B,cAAc,CAAC2D,YAAY,CAAC;MAC9B;IACF;EACF,CAAC,EACD,MAAM,CACP;EAEDtG,cAAc,CAAC,YAAY;IACzB4B,aAAa,CAAC,IAAI,CAAC;IAEnB,IAAI;MACF,MAAMpB,OAAO,CAAC0H,KAAK,EAAE;MACrB,MAAMnG,IAAI,CAAChB,MAAM,CAAC;IACpB,CAAC,CAAC,OAAOoH,KAAK,EAAE;MAAA,IAAAC,gBAAA,EAAAC,sBAAA;MACdrH,OAAO,aAAPA,OAAO,wBAAAoH,gBAAA,GAAPpH,OAAO,CAAEsH,OAAO,cAAAF,gBAAA,uBAAhBA,gBAAA,CAAAlC,IAAA,CAAAlF,OAAO,EAAYmH,KAAK,CAAC;MACzBnH,OAAO,aAAPA,OAAO,wBAAAqH,sBAAA,GAAPrH,OAAO,CAAEqG,gBAAgB,cAAAgB,sBAAA,uBAAzBA,sBAAA,CAAAnC,IAAA,CAAAlF,OAAO,CAAsB;IAC/B,CAAC,SAAS;MACRY,aAAa,CAAC,KAAK,CAAC;IACtB;IAEA,OAAO,MAAM;MACXpB,OAAO,CAAC+H,IAAI,EAAE,CAACC,KAAK,CAAC3I,IAAI,CAAC;IAC5B,CAAC;EACH,CAAC,EAAE,CAACW,OAAO,CAACgH,GAAG,EAAEzG,MAAM,CAAC,CAAC;EAEzB,MAAM0H,OAAsD,GAAGvI,gBAAgB,CAAC,YAAY;IAC1F2B,gBAAgB,CAAC,IAAI,CAAC;IACtB,MAAME,IAAI,CAAChB,MAAM,CAAC;IAClBc,gBAAgB,CAAC,KAAK,CAAC;EACzB,CAAC,CAAC;EAEF,MAAM6G,IAAgD,GAAGxI,gBAAgB,CAAC,YAAY;IAAA,IAAAyI,mBAAA;IACpF,IAAI1H,QAAQ,CAACkB,OAAO,KAAAwG,mBAAA,GAAI1H,QAAQ,CAACkB,OAAO,cAAAwG,mBAAA,eAAhBA,mBAAA,CAAkBtG,OAAO,EAAE;MAAA,IAAAuG,mBAAA,EAAAC,kBAAA;MACjD,MAAMrG,IAAI,GAAG,QAAAoG,mBAAA,GAAM3H,QAAQ,CAACkB,OAAO,cAAAyG,mBAAA,uBAAhBA,mBAAA,CAAkBnG,IAAI,EAAE;MAC3CjB,cAAc,CAACgB,IAAI,EAAE,KAAK,GAAAqG,kBAAA,GAAE/H,GAAG,CAAC4B,WAAW,cAAAmG,kBAAA,uBAAfA,kBAAA,CAAiB9H,MAAM,CAAC;IACtD;EACF,CAAC,CAAC;EACF,MAAM+H,OAAsD,GAAG5I,gBAAgB,CAC7E;IAAA,IAAA6I,mBAAA;IAAA,OAAM,EAAAA,mBAAA,GAAA9H,QAAQ,CAACkB,OAAO,cAAA4G,mBAAA,uBAAhBA,mBAAA,CAAkB1G,OAAO,KAAI,KAAK;EAAA,EACzC;EAED,MAAM2G,IAAgD,GAAG9I,gBAAgB,CAACN,UAAU,CAAC;EACrF,MAAMyC,OAAsD,GAAGnC,gBAAgB,CAAC,MAAM,KAAK,CAAC;EAE5F,MAAM+I,eAAsE,GAAG/I,gBAAgB,CAC7F,CAACgJ,MAAM,EAAEC,SAAS,KAAK;IACrB,OAAO,IAAIC,OAAO,CAAC,CAACC,OAAO,EAAEC,MAAM,KAAK;MACtC9I,OAAO,CACJyI,eAAe,CAACC,MAAM,CAAC,CACvBC,SAAS,CAAEI,cAAc,IAAK;QAC7B,IAAIA,cAAc,CAACC,aAAa,EAAE,EAAE;UAAA,IAAAC,kBAAA;UAClCjI,cAAc,CAAC,CAAC+H,cAAc,CAAC,EAAE,KAAK,GAAAE,kBAAA,GAAE3I,GAAG,CAAC4B,WAAW,cAAA+G,kBAAA,uBAAfA,kBAAA,CAAiB1I,MAAM,CAAC;UAChEoI,SAAS,aAATA,SAAS,uBAATA,SAAS,CAAGI,cAAc,CAAC;QAC7B;MACF,CAAC,CAAC,CACDG,WAAW,CAAEC,WAAW,IAAK;QAC5B,IAAIA,WAAW,CAACH,aAAa,EAAE,EAAE;UAAA,IAAAI,kBAAA;UAC/BpI,cAAc,CAAC,CAACmI,WAAW,CAAC,EAAE,KAAK,GAAAC,kBAAA,GAAE9I,GAAG,CAAC4B,WAAW,cAAAkH,kBAAA,uBAAfA,kBAAA,CAAiB7I,MAAM,CAAC;UAC7DsI,OAAO,CAACM,WAAW,CAAC;QACtB;MACF,CAAC,CAAC,CACDE,QAAQ,CAAC,CAACC,GAAG,EAAEC,aAAa,KAAK;QAChC,IAAIA,aAAa,EAAE;UAAA,IAAAC,kBAAA;UACjBxI,cAAc,CAAC,CAACuI,aAAa,CAAC,EAAE,KAAK,GAAAC,kBAAA,GAAElJ,GAAG,CAAC4B,WAAW,cAAAsH,kBAAA,uBAAfA,kBAAA,CAAiBjJ,MAAM,CAAC;QACjE;QACAuI,MAAM,CAACQ,GAAG,CAAC;MACb,CAAC,CAAC;IACN,CAAC,CAAC;EACJ,CAAC,CACF;EAED,MAAMG,eAAsE,GAAG/J,gBAAgB,CAC7F,CAACgJ,MAAM,EAAEC,SAAS,KAAK;IACrB,OAAO,IAAIC,OAAO,CAAC,CAACC,OAAO,EAAEC,MAAM,KAAK;MACtC9I,OAAO,CACJyJ,eAAe,CAACf,MAAM,CAAC,CACvBC,SAAS,CAAEI,cAAc,IAAK;QAC7B,IAAIA,cAAc,CAACW,aAAa,EAAE,EAAE;UAAA,IAAAC,kBAAA;UAClC3I,cAAc,CAAC,CAAC+H,cAAc,CAAC,EAAE,KAAK,GAAAY,kBAAA,GAAErJ,GAAG,CAAC4B,WAAW,cAAAyH,kBAAA,uBAAfA,kBAAA,CAAiBpJ,MAAM,CAAC;UAChEoI,SAAS,aAATA,SAAS,uBAATA,SAAS,CAAGI,cAAc,CAAC;QAC7B;MACF,CAAC,CAAC,CACDG,WAAW,CAAEC,WAAW,IAAK;QAC5B,IAAIA,WAAW,CAACO,aAAa,EAAE,EAAE;UAAA,IAAAE,kBAAA;UAC/B5I,cAAc,CAAC,CAACmI,WAAW,CAAC,EAAE,KAAK,GAAAS,kBAAA,GAAEtJ,GAAG,CAAC4B,WAAW,cAAA0H,kBAAA,uBAAfA,kBAAA,CAAiBrJ,MAAM,CAAC;UAC7DsI,OAAO,CAACM,WAAW,CAAC;QACtB;MACF,CAAC,CAAC,CACDE,QAAQ,CAAC,CAACC,GAAG,EAAEC,aAAa,KAAK;QAChC,IAAIA,aAAa,EAAE;UAAA,IAAAM,kBAAA;UACjB7I,cAAc,CAAC,CAACuI,aAAa,CAAC,EAAE,KAAK,GAAAM,kBAAA,GAAEvJ,GAAG,CAAC4B,WAAW,cAAA2H,kBAAA,uBAAfA,kBAAA,CAAiBtJ,MAAM,CAAC;QACjE;QACAuI,MAAM,CAACQ,GAAG,CAAC;MACb,CAAC,CAAC;IACN,CAAC,CAAC;EACJ,CAAC,CACF;EAED,MAAMQ,iBAA0E,GAAGpK,gBAAgB,CACjG,OAAO8G,SAAS,EAAEkC,MAAM,KAAK;IAAA,IAAAqB,kBAAA;IAC3B,MAAMC,cAAc,GAAG,MAAMhK,OAAO,CAAC8J,iBAAiB,CAACtD,SAAS,EAAEkC,MAAM,CAAC;IACzE1H,cAAc,CAAC,CAACgJ,cAAc,CAAC,EAAE,KAAK,GAAAD,kBAAA,GAAEzJ,GAAG,CAAC4B,WAAW,cAAA6H,kBAAA,uBAAfA,kBAAA,CAAiBxJ,MAAM,CAAC;IAChE,OAAOyJ,cAAc;EACvB,CAAC,CACF;EACD,MAAMC,iBAA0E,GAAGvK,gBAAgB,CACjG,OAAO8G,SAAS,EAAEkC,MAAM,KAAK;IAAA,IAAAwB,kBAAA;IAC3B,MAAMF,cAAc,GAAG,MAAMhK,OAAO,CAACiK,iBAAiB,CAACzD,SAAS,EAAEkC,MAAM,CAAC;IACzE1H,cAAc,CAAC,CAACgJ,cAAc,CAAC,EAAE,KAAK,GAAAE,kBAAA,GAAE5J,GAAG,CAAC4B,WAAW,cAAAgI,kBAAA,uBAAfA,kBAAA,CAAiB3J,MAAM,CAAC;IAChE,OAAOyJ,cAAc;EACvB,CAAC,CACF;EACD,MAAMG,aAAkE,GAAGzK,gBAAgB,CAAC,MAAO6J,aAAa,IAAK;IAAA,IAAAa,kBAAA;IACnH,MAAMrE,OAAO,GAAG,MAAM,CAAC,MAAM;MAC3B,IAAIwD,aAAa,CAACP,aAAa,EAAE,EAAE,OAAOhJ,OAAO,CAACqK,iBAAiB,CAACd,aAAa,CAAC;MAClF,IAAIA,aAAa,CAACG,aAAa,EAAE,EAAE,OAAO1J,OAAO,CAACsK,iBAAiB,CAACf,aAAa,CAAC;MAClF,OAAO,IAAI;IACb,CAAC,GAAG;IAEJ,IAAIxD,OAAO,EAAE/E,cAAc,CAAC,CAAC+E,OAAO,CAAC,EAAE,KAAK,GAAAqE,kBAAA,GAAE9J,GAAG,CAAC4B,WAAW,cAAAkI,kBAAA,uBAAfA,kBAAA,CAAiB7J,MAAM,CAAC;EACxE,CAAC,CAAC;EACF,MAAMgK,aAAkE,GAAG7K,gBAAgB,CAAC,MAAOqG,OAAO,IAAK;IAC7G,IAAIA,OAAO,CAACyE,aAAa,KAAK,WAAW,EAAE;MACzC,IAAIzE,OAAO,CAACiD,aAAa,EAAE,EAAE,MAAMhJ,OAAO,CAACuK,aAAa,CAACxE,OAAO,CAAC;MACjE,IAAIA,OAAO,CAAC2D,aAAa,EAAE,EAAE,MAAM1J,OAAO,CAACuK,aAAa,CAACxE,OAAO,CAAC;IACnE,CAAC,MAAM;MACL5E,cAAc,CAAC,CAAC4E,OAAO,CAACS,SAAS,CAAC,EAAE,CAACT,OAAO,CAAC0E,KAAK,CAAC,CAAC;IACtD;EACF,CAAC,CAAC;EACF,MAAMC,gBAAwE,GAAGhL,gBAAgB,CAAC,MAAM;IAAA,IAAAiL,kBAAA;IACtG1J,iBAAiB,CAAC,EAAE,EAAE,IAAI,GAAA0J,kBAAA,GAAErK,GAAG,CAAC4B,WAAW,cAAAyI,kBAAA,uBAAfA,kBAAA,CAAiBpK,MAAM,CAAC;EACtD,CAAC,CAAC;EAEF,OAAO;IACLK,OAAO;IACPC,UAAU;IACVoH,OAAO;IACPnH,QAAQ;IACRC,WAAW;IACXyH,IAAI;IACJ3G,OAAO;IACPqG,IAAI;IACJI,OAAO;IACPG,eAAe;IACfgB,eAAe;IACfK,iBAAiB;IACjBG,iBAAiB;IACjBE,aAAa;IACbI,aAAa;IACbG;EACF,CAAC;AACH,CAAC"}