{"version":3,"names":["useEffect","useRef","GroupChannelEventSource","GroupChannelFilter","GroupChannelListOrder","confirmAndMarkAsDelivered","useAsyncEffect","useFreshCallback","useUniqHandlerId","useAppFeatures","useChannelHandler","useGroupChannelListReducer","createGroupChannelListCollection","sdk","collectionCreator","passedCollection","filter","includeEmpty","groupChannel","createGroupChannelCollection","limit","order","LATEST_LAST_MESSAGE","useGroupChannelListWithCollection","userId","options","handlerId","deliveryReceiptEnabled","collectionRef","loading","groupChannels","refreshing","appendChannels","deleteChannels","updateRefreshing","updateLoading","updateChannelsAndMarkAsDelivered","markAsDelivered","source","updatedChannels","_collectionRef$curren","channels","current","EVENT_MESSAGE_RECEIVED","EVENT_MESSAGE_SENT","SYNC_CHANNEL_BACKGROUND","SYNC_CHANNEL_CHANGELOGS","undefined","init","uid","_collectionRef$curren2","dispose","_collectionRef$curren3","_collectionRef$curren4","setGroupChannelCollectionHandler","onChannelsAdded","context","onChannelsUpdated","onChannelsDeleted","hasMore","_collectionRef$curren5","loadMore","_collectionRef$curren6","onUserBanned","channel","user","isMe","url","refresh","next","_collectionRef$curren7","_collectionRef$curren8"],"sources":["useGroupChannelListWithCollection.ts"],"sourcesContent":["import { useEffect, useRef } from 'react';\n\nimport { GroupChannelEventSource, GroupChannelFilter, GroupChannelListOrder } from '@sendbird/chat/groupChannel';\nimport type { SendbirdBaseChannel, SendbirdChatSDK, SendbirdGroupChannelCollection } from '@sendbird/uikit-utils';\nimport { confirmAndMarkAsDelivered, useAsyncEffect, useFreshCallback, useUniqHandlerId } from '@sendbird/uikit-utils';\n\nimport { useAppFeatures } from '../../common/useAppFeatures';\nimport { useChannelHandler } from '../../handler/useChannelHandler';\nimport type { UseGroupChannelList, UseGroupChannelListOptions } from '../../types';\nimport { useGroupChannelListReducer } from './reducer';\n\nconst createGroupChannelListCollection = (\n  sdk: SendbirdChatSDK,\n  collectionCreator: UseGroupChannelListOptions['collectionCreator'],\n) => {\n  const passedCollection = collectionCreator?.();\n  if (passedCollection) return passedCollection;\n\n  const filter = new GroupChannelFilter();\n  filter.includeEmpty = false;\n\n  return sdk.groupChannel.createGroupChannelCollection({\n    filter,\n    limit: 20,\n    order: GroupChannelListOrder.LATEST_LAST_MESSAGE,\n  });\n};\n\nexport const useGroupChannelListWithCollection: UseGroupChannelList = (sdk, userId, options) => {\n  const handlerId = useUniqHandlerId('useGroupChannelListWithCollection');\n  const { deliveryReceiptEnabled } = useAppFeatures(sdk);\n\n  const collectionRef = useRef<SendbirdGroupChannelCollection>();\n\n  const { loading, groupChannels, refreshing, appendChannels, deleteChannels, updateRefreshing, updateLoading } =\n    useGroupChannelListReducer();\n\n  const updateChannelsAndMarkAsDelivered = (\n    markAsDelivered: boolean,\n    source?: GroupChannelEventSource,\n    updatedChannels?: SendbirdBaseChannel[],\n  ) => {\n    const channels = collectionRef.current?.channels ?? [];\n    appendChannels(channels, true);\n    if (markAsDelivered && deliveryReceiptEnabled) {\n      switch (source) {\n        case GroupChannelEventSource.EVENT_MESSAGE_RECEIVED:\n        case GroupChannelEventSource.EVENT_MESSAGE_SENT:\n        case GroupChannelEventSource.SYNC_CHANNEL_BACKGROUND:\n        case GroupChannelEventSource.SYNC_CHANNEL_CHANGELOGS:\n        case undefined:\n          confirmAndMarkAsDelivered(updatedChannels ?? channels);\n          break;\n      }\n    }\n  };\n\n  const init = useFreshCallback(async (uid?: string) => {\n    if (collectionRef.current) collectionRef.current?.dispose();\n\n    if (uid) {\n      collectionRef.current = createGroupChannelListCollection(sdk, options?.collectionCreator);\n\n      collectionRef.current?.setGroupChannelCollectionHandler({\n        onChannelsAdded: (context, channels) => {\n          updateChannelsAndMarkAsDelivered(true, context.source, channels);\n        },\n        onChannelsUpdated: (context, channels) => {\n          updateChannelsAndMarkAsDelivered(true, context.source, channels);\n        },\n        onChannelsDeleted: () => {\n          updateChannelsAndMarkAsDelivered(false);\n        },\n      });\n\n      if (collectionRef.current?.hasMore) {\n        await collectionRef.current?.loadMore();\n        updateChannelsAndMarkAsDelivered(true);\n      }\n    }\n  });\n\n  useEffect(() => {\n    return () => {\n      if (collectionRef.current) collectionRef.current?.dispose();\n    };\n  }, []);\n\n  useAsyncEffect(async () => {\n    updateLoading(true);\n    await init(userId);\n    updateLoading(false);\n  }, [userId]);\n\n  useChannelHandler(sdk, handlerId, {\n    onUserBanned: (channel, user) => {\n      const isMe = user.userId === userId;\n      if (isMe) deleteChannels([channel.url]);\n      else updateChannelsAndMarkAsDelivered(false);\n    },\n  });\n\n  const refresh = useFreshCallback(async () => {\n    updateRefreshing(true);\n    await init(userId);\n    updateRefreshing(false);\n  });\n\n  const next = useFreshCallback(async () => {\n    if (collectionRef.current?.hasMore) {\n      await collectionRef.current?.loadMore();\n      updateChannelsAndMarkAsDelivered(true);\n    }\n  });\n\n  return {\n    loading,\n    groupChannels,\n    refresh,\n    refreshing,\n    next,\n  };\n};\n"],"mappings":"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"}