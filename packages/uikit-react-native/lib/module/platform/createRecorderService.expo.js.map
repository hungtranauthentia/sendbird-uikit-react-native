{"version":3,"names":["Platform","matchesOneOf","sleep","VoiceMessageConfig","expoPermissionGranted","createExpoRecorderService","_ref","avModule","VoiceRecorder","constructor","_defineProperty","undefined","minDuration","DEFAULT","RECORDER","MIN_DURATION","maxDuration","MAX_DURATION","extension","EXTENSION","minWaitingTime","elapsedTime","Date","now","_recordStartedAt","Audio","Recording","Set","sampleRate","SAMPLE_RATE","bitRate","BIT_RATE","numberOfChannels","CHANNELS","android","_audioSettings","options","audioEncoder","AndroidAudioEncoder","AAC","outputFormat","AndroidOutputFormat","MPEG_4","ios","IOSOutputFormat","MPEG4AAC","audioQuality","IOSAudioQuality","HIGH","web","setState","OS","setAudioModeAsync","allowsRecordingIOS","playsInSilentModeIOS","_recorder","_isDoneRecording","setProgressUpdateInterval","setOnRecordingStatusUpdate","status","completed","durationMillis","stop","isRecording","_recordingSubscribers","forEach","callback","currentTime","prepareToRecordAsync","_audioOptions","state","_stateSubscribers","getPermissionsAsync","requestPermissionsAsync","add","delete","prepare","startAsync","uri","getURI","e","buffer","_getRecorderStopSafeBuffer","stopAndUnloadAsync","clear"],"sources":["createRecorderService.expo.tsx"],"sourcesContent":["import * as ExpoAV from 'expo-av';\nimport type { RecordingOptions } from 'expo-av/build/Audio/Recording.types';\nimport { Platform } from 'react-native';\n\nimport { matchesOneOf, sleep } from '@sendbird/uikit-utils';\n\nimport VoiceMessageConfig from '../libs/VoiceMessageConfig';\nimport expoPermissionGranted from '../utils/expoPermissionGranted';\nimport type { RecorderServiceInterface, Unsubscribe } from './types';\n\ntype RecordingListener = Parameters<RecorderServiceInterface['addRecordingListener']>[number];\ntype StateListener = Parameters<RecorderServiceInterface['addStateListener']>[number];\ntype Modules = {\n  avModule: typeof ExpoAV;\n};\nconst createExpoRecorderService = ({ avModule }: Modules): RecorderServiceInterface => {\n  class VoiceRecorder implements RecorderServiceInterface {\n    public uri: RecorderServiceInterface['uri'] = undefined;\n    public state: RecorderServiceInterface['state'] = 'idle';\n    public options: RecorderServiceInterface['options'] = {\n      minDuration: VoiceMessageConfig.DEFAULT.RECORDER.MIN_DURATION,\n      maxDuration: VoiceMessageConfig.DEFAULT.RECORDER.MAX_DURATION,\n      extension: VoiceMessageConfig.DEFAULT.RECORDER.EXTENSION,\n    };\n\n    // NOTE: In Android, even when startRecorder() is awaited, if stop() is executed immediately afterward, an error occurs\n    private _recordStartedAt = 0;\n    private _getRecorderStopSafeBuffer = () => {\n      const minWaitingTime = 500;\n      const elapsedTime = Date.now() - this._recordStartedAt;\n      if (elapsedTime > minWaitingTime) return 0;\n      else return minWaitingTime - elapsedTime;\n    };\n\n    private _recorder = new avModule.Audio.Recording();\n    private readonly _recordingSubscribers = new Set<RecordingListener>();\n    private readonly _stateSubscribers = new Set<StateListener>();\n    private readonly _audioSettings = {\n      sampleRate: VoiceMessageConfig.DEFAULT.RECORDER.SAMPLE_RATE,\n      bitRate: VoiceMessageConfig.DEFAULT.RECORDER.BIT_RATE,\n      numberOfChannels: VoiceMessageConfig.DEFAULT.RECORDER.CHANNELS,\n      // encoding: mpeg4_aac\n    };\n    private readonly _audioOptions: RecordingOptions = {\n      android: {\n        ...this._audioSettings,\n        extension: `.${this.options.extension}`,\n        audioEncoder: avModule.Audio.AndroidAudioEncoder.AAC,\n        outputFormat: avModule.Audio.AndroidOutputFormat.MPEG_4,\n      },\n      ios: {\n        ...this._audioSettings,\n        extension: `.${this.options.extension}`,\n        outputFormat: avModule.Audio.IOSOutputFormat.MPEG4AAC,\n        audioQuality: avModule.Audio.IOSAudioQuality.HIGH,\n      },\n      web: {},\n    };\n\n    private prepare = async () => {\n      this.setState('preparing');\n      if (Platform.OS === 'ios') {\n        await avModule.Audio.setAudioModeAsync({ allowsRecordingIOS: true, playsInSilentModeIOS: true });\n      }\n\n      if (this._recorder._isDoneRecording) {\n        this._recorder = new avModule.Audio.Recording();\n      }\n      this._recorder.setProgressUpdateInterval(100);\n      this._recorder.setOnRecordingStatusUpdate((status) => {\n        const completed = status.durationMillis >= this.options.maxDuration;\n        if (completed) this.stop();\n        if (status.isRecording) {\n          this._recordingSubscribers.forEach((callback) => {\n            callback({ currentTime: status.durationMillis, completed: completed });\n          });\n        }\n      });\n      await this._recorder.prepareToRecordAsync(this._audioOptions);\n    };\n\n    private setState = (state: RecorderServiceInterface['state']) => {\n      this.state = state;\n      this._stateSubscribers.forEach((callback) => {\n        callback(state);\n      });\n    };\n\n    public requestPermission = async (): Promise<boolean> => {\n      const status = await avModule.Audio.getPermissionsAsync();\n      if (expoPermissionGranted([status])) {\n        return true;\n      } else {\n        const status = await avModule.Audio.requestPermissionsAsync();\n        return expoPermissionGranted([status]);\n      }\n    };\n\n    public addRecordingListener = (callback: RecordingListener): Unsubscribe => {\n      this._recordingSubscribers.add(callback);\n      return () => {\n        this._recordingSubscribers.delete(callback);\n      };\n    };\n\n    public addStateListener = (callback: StateListener): Unsubscribe => {\n      this._stateSubscribers.add(callback);\n      return () => {\n        this._stateSubscribers.delete(callback);\n      };\n    };\n\n    public record = async (): Promise<void> => {\n      if (matchesOneOf(this.state, ['idle', 'completed'])) {\n        try {\n          await this.prepare();\n          await this._recorder.startAsync();\n\n          if (Platform.OS === 'android') {\n            this._recordStartedAt = Date.now();\n          }\n\n          const uri = this._recorder.getURI();\n          if (uri) this.uri = uri;\n          this.setState('recording');\n        } catch (e) {\n          this.setState('idle');\n          throw e;\n        }\n      }\n    };\n\n    public stop = async (): Promise<void> => {\n      if (matchesOneOf(this.state, ['recording'])) {\n        if (Platform.OS === 'android') {\n          const buffer = this._getRecorderStopSafeBuffer();\n          if (buffer > 0) await sleep(buffer);\n        }\n\n        await this._recorder.stopAndUnloadAsync();\n        if (Platform.OS === 'ios') {\n          await avModule.Audio.setAudioModeAsync({ allowsRecordingIOS: false, playsInSilentModeIOS: false });\n        }\n        this.setState('completed');\n      }\n    };\n\n    public reset = async (): Promise<void> => {\n      await this.stop();\n      this.uri = undefined;\n      this._recordingSubscribers.clear();\n      this._recorder = new avModule.Audio.Recording();\n      this.setState('idle');\n    };\n  }\n\n  return new VoiceRecorder();\n};\n\nexport default createExpoRecorderService;\n"],"mappings":"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"}