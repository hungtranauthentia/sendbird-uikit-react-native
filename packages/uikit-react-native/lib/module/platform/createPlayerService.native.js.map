{"version":3,"names":["Platform","matchesOneOf","sleep","createNativePlayerService","_ref","audioRecorderModule","permissionModule","module","default","VoicePlayer","constructor","_defineProperty","Set","state","stateSubscribers","forEach","callback","addPlayBackListener","data","stopped","currentPosition","duration","stop","playbackSubscribers","currentTime","removePlayBackListener","OS","READ_MEDIA_AUDIO","READ_EXTERNAL_STORAGE","PERMISSIONS","ANDROID","permission","Version","status","check","request","add","delete","uri","setState","setListener","startPlayer","e","undefined","removeListener","resumePlayer","pausePlayer","stopPlayer","clear","time","seekToPlayer","setSubscriptionDuration"],"sources":["createPlayerService.native.tsx"],"sourcesContent":["import { Platform } from 'react-native';\nimport type * as RNAudioRecorder from 'react-native-audio-recorder-player';\nimport * as Permissions from 'react-native-permissions';\n\nimport { matchesOneOf, sleep } from '@sendbird/uikit-utils';\n\nimport type { PlayerServiceInterface, Unsubscribe } from './types';\n\ntype Modules = {\n  audioRecorderModule: typeof RNAudioRecorder;\n  permissionModule: typeof Permissions;\n};\ntype PlaybackListener = Parameters<PlayerServiceInterface['addPlaybackListener']>[number];\ntype StateListener = Parameters<PlayerServiceInterface['addStateListener']>[number];\nconst createNativePlayerService = ({ audioRecorderModule, permissionModule }: Modules): PlayerServiceInterface => {\n  const module = new audioRecorderModule.default();\n\n  class VoicePlayer implements PlayerServiceInterface {\n    uri?: string;\n    state: PlayerServiceInterface['state'] = 'idle';\n\n    private readonly playbackSubscribers = new Set<PlaybackListener>();\n    private readonly stateSubscribers = new Set<StateListener>();\n\n    constructor() {\n      module.setSubscriptionDuration(0.1);\n    }\n\n    private setState = (state: PlayerServiceInterface['state']) => {\n      this.state = state;\n      this.stateSubscribers.forEach((callback) => {\n        callback(state);\n      });\n    };\n\n    private setListener = () => {\n      module.addPlayBackListener((data) => {\n        const stopped = data.currentPosition >= data.duration;\n\n        if (stopped) this.stop();\n        if (this.state === 'playing') {\n          this.playbackSubscribers.forEach((callback) => {\n            callback({ currentTime: data.currentPosition, duration: data.duration, stopped });\n          });\n        }\n      });\n    };\n\n    private removeListener = () => {\n      module.removePlayBackListener();\n    };\n\n    public requestPermission = async (): Promise<boolean> => {\n      if (Platform.OS === 'android') {\n        const { READ_MEDIA_AUDIO, READ_EXTERNAL_STORAGE } = permissionModule.PERMISSIONS.ANDROID;\n        const permission = Platform.Version > 32 ? READ_MEDIA_AUDIO : READ_EXTERNAL_STORAGE;\n\n        const status = await permissionModule.check(permission);\n        if (status === 'granted') {\n          return true;\n        } else {\n          const status = await permissionModule.request(permission);\n          return status === 'granted';\n        }\n      } else {\n        return true;\n      }\n    };\n\n    public addPlaybackListener = (callback: PlaybackListener): Unsubscribe => {\n      this.playbackSubscribers.add(callback);\n      return () => {\n        this.playbackSubscribers.delete(callback);\n      };\n    };\n\n    public addStateListener = (callback: (state: PlayerServiceInterface['state']) => void): Unsubscribe => {\n      this.stateSubscribers.add(callback);\n      return () => {\n        this.stateSubscribers.delete(callback);\n      };\n    };\n\n    public play = async (uri: string): Promise<void> => {\n      if (matchesOneOf(this.state, ['idle', 'stopped'])) {\n        try {\n          this.setState('preparing');\n          this.uri = uri;\n          this.setListener();\n\n          // FIXME: Workaround, `module.startPlayer()` caused a significant frame-drop and prevented the 'preparing' UI transition.\n          await sleep(0);\n          await module.startPlayer(uri);\n\n          this.setState('playing');\n        } catch (e) {\n          this.setState('idle');\n          this.uri = undefined;\n          this.removeListener();\n          throw e;\n        }\n      } else if (matchesOneOf(this.state, ['paused']) && this.uri === uri) {\n        try {\n          this.setListener();\n          await module.resumePlayer();\n          this.setState('playing');\n        } catch (e) {\n          this.removeListener();\n          throw e;\n        }\n      }\n    };\n\n    public pause = async (): Promise<void> => {\n      if (matchesOneOf(this.state, ['playing'])) {\n        await module.pausePlayer();\n        this.removeListener();\n        this.setState('paused');\n      }\n    };\n\n    public stop = async (): Promise<void> => {\n      if (matchesOneOf(this.state, ['preparing', 'playing', 'paused'])) {\n        await module.stopPlayer();\n        this.removeListener();\n        this.setState('stopped');\n      }\n    };\n\n    public reset = async (): Promise<void> => {\n      await this.stop();\n      this.setState('idle');\n      this.uri = undefined;\n      this.playbackSubscribers.clear();\n      this.stateSubscribers.clear();\n    };\n\n    public seek = async (time: number): Promise<void> => {\n      if (matchesOneOf(this.state, ['playing', 'paused'])) {\n        await module.seekToPlayer(time);\n      }\n    };\n  }\n\n  return new VoicePlayer();\n};\n\nexport default createNativePlayerService;\n"],"mappings":"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"}