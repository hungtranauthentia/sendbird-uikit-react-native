{"version":3,"names":["matchesOneOf","expoPermissionGranted","createExpoPlayerService","_ref","avModule","sound","Audio","Sound","VoicePlayer","constructor","_defineProperty","Set","state","stateSubscribers","forEach","callback","setProgressUpdateIntervalAsync","setOnPlaybackStatusUpdate","status","isLoaded","didJustFinish","stop","isPlaying","playbackSubscribers","currentTime","positionMillis","duration","durationMillis","stopped","getPermissionsAsync","requestPermissionsAsync","add","delete","uri","setState","loadAsync","shouldPlay","prepare","setListener","playAsync","e","undefined","removeListener","pauseAsync","stopAsync","unloadAsync","clear","time","playFromPositionAsync"],"sources":["createPlayerService.expo.tsx"],"sourcesContent":["import type * as ExpoAV from 'expo-av';\n\nimport { matchesOneOf } from '@sendbird/uikit-utils';\n\nimport expoPermissionGranted from '../utils/expoPermissionGranted';\nimport type { PlayerServiceInterface, Unsubscribe } from './types';\n\ntype Modules = {\n  avModule: typeof ExpoAV;\n};\ntype PlaybackListener = Parameters<PlayerServiceInterface['addPlaybackListener']>[number];\ntype StateListener = Parameters<PlayerServiceInterface['addStateListener']>[number];\nconst createExpoPlayerService = ({ avModule }: Modules): PlayerServiceInterface => {\n  const sound = new avModule.Audio.Sound();\n\n  class VoicePlayer implements PlayerServiceInterface {\n    uri?: string;\n    state: PlayerServiceInterface['state'] = 'idle';\n\n    private readonly playbackSubscribers = new Set<PlaybackListener>();\n    private readonly stateSubscribers = new Set<StateListener>();\n\n    private setState = (state: PlayerServiceInterface['state']) => {\n      this.state = state;\n      this.stateSubscribers.forEach((callback) => {\n        callback(state);\n      });\n    };\n\n    private setListener = () => {\n      sound.setProgressUpdateIntervalAsync(100);\n      sound.setOnPlaybackStatusUpdate((status) => {\n        if (status.isLoaded) {\n          if (status.didJustFinish) this.stop();\n          if (status.isPlaying) {\n            this.playbackSubscribers.forEach((callback) => {\n              callback({\n                currentTime: status.positionMillis,\n                duration: status.durationMillis ?? 0,\n                stopped: status.didJustFinish,\n              });\n            });\n          }\n        }\n      });\n    };\n\n    private removeListener = () => {\n      sound.setOnPlaybackStatusUpdate(null);\n    };\n\n    public requestPermission = async (): Promise<boolean> => {\n      const status = await avModule.Audio.getPermissionsAsync();\n      if (expoPermissionGranted([status])) {\n        return true;\n      } else {\n        const status = await avModule.Audio.requestPermissionsAsync();\n        return expoPermissionGranted([status]);\n      }\n    };\n\n    public addPlaybackListener = (callback: PlaybackListener): Unsubscribe => {\n      this.playbackSubscribers.add(callback);\n      return () => {\n        this.playbackSubscribers.delete(callback);\n      };\n    };\n\n    public addStateListener = (callback: (state: PlayerServiceInterface['state']) => void): Unsubscribe => {\n      this.stateSubscribers.add(callback);\n      return () => {\n        this.stateSubscribers.delete(callback);\n      };\n    };\n\n    private prepare = async (uri: string) => {\n      this.setState('preparing');\n      await sound.loadAsync({ uri }, { shouldPlay: false }, true);\n      this.uri = uri;\n    };\n\n    public play = async (uri: string): Promise<void> => {\n      if (matchesOneOf(this.state, ['idle', 'stopped'])) {\n        try {\n          await this.prepare(uri);\n          this.setListener();\n          await sound.playAsync();\n          this.setState('playing');\n        } catch (e) {\n          this.setState('idle');\n          this.uri = undefined;\n          this.removeListener();\n          throw e;\n        }\n      } else if (matchesOneOf(this.state, ['paused']) && this.uri === uri) {\n        try {\n          this.setListener();\n          await sound.playAsync();\n          this.setState('playing');\n        } catch (e) {\n          this.removeListener();\n          throw e;\n        }\n      }\n    };\n\n    public pause = async (): Promise<void> => {\n      if (matchesOneOf(this.state, ['playing'])) {\n        await sound.pauseAsync();\n        this.removeListener();\n        this.setState('paused');\n      }\n    };\n\n    public stop = async (): Promise<void> => {\n      if (matchesOneOf(this.state, ['playing', 'paused'])) {\n        await sound.stopAsync();\n        await sound.unloadAsync();\n        this.removeListener();\n        this.setState('stopped');\n      }\n    };\n\n    public reset = async (): Promise<void> => {\n      await this.stop();\n      this.setState('idle');\n      this.uri = undefined;\n      this.playbackSubscribers.clear();\n      this.stateSubscribers.clear();\n    };\n\n    public seek = async (time: number): Promise<void> => {\n      if (matchesOneOf(this.state, ['playing', 'paused'])) {\n        await sound.playFromPositionAsync(time);\n      }\n    };\n  }\n\n  return new VoicePlayer();\n};\n\nexport default createExpoPlayerService;\n"],"mappings":"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"}