{"version":3,"names":["useRef","Platform","Logger","useFreshCallback","useIIFE","usePlatformService","useSendbirdChat","usePushTokenRegistration","sdk","notificationService","refreshListener","registerToken","unregisterToken","getToken","select","ios","token","registerAPNSPushTokenForCurrentUser","default","registerFCMPushTokenForCurrentUser","unregisterAPNSPushTokenForCurrentUser","unregisterFCMPushTokenForCurrentUser","getAPNSToken","getFCMToken","registerPushTokenForCurrentUser","hasPermission","hasPushPermission","pushPermission","requestPushPermission","warn","log","current","onTokenRefresh","unregisterPushTokenForCurrentUser","_refreshListener$curr","call"],"sources":["usePushTokenRegistration.ts"],"sourcesContent":["import { useRef } from 'react';\nimport { Platform } from 'react-native';\n\nimport { Logger, useFreshCallback, useIIFE } from '@sendbird/uikit-utils';\n\nimport { usePlatformService, useSendbirdChat } from './useContext';\n\nconst usePushTokenRegistration = () => {\n  const { sdk } = useSendbirdChat();\n  const { notificationService } = usePlatformService();\n\n  const refreshListener = useRef<() => void>();\n  const [registerToken, unregisterToken, getToken] = useIIFE(() => {\n    return [\n      Platform.select({\n        ios: (token: string) => sdk.registerAPNSPushTokenForCurrentUser(token),\n        default: (token: string) => sdk.registerFCMPushTokenForCurrentUser(token),\n      }),\n      Platform.select({\n        ios: (token: string) => sdk.unregisterAPNSPushTokenForCurrentUser(token),\n        default: (token: string) => sdk.unregisterFCMPushTokenForCurrentUser(token),\n      }),\n      Platform.select({\n        ios: notificationService.getAPNSToken,\n        default: notificationService.getFCMToken,\n      }),\n    ];\n  });\n\n  const registerPushTokenForCurrentUser = useFreshCallback(async () => {\n    // Check and request push permission\n    const hasPermission = await notificationService.hasPushPermission();\n    if (!hasPermission) {\n      const pushPermission = await notificationService.requestPushPermission();\n      if (!pushPermission) {\n        Logger.warn('[usePushTokenRegistration]', 'Not granted push permission');\n        return;\n      }\n    }\n\n    // Register device token\n    const token = await getToken();\n    if (token) {\n      Logger.log('[usePushTokenRegistration]', 'registered token:', token);\n      registerToken(token);\n    }\n\n    // Remove listener\n    refreshListener.current = notificationService.onTokenRefresh(registerToken);\n  });\n\n  const unregisterPushTokenForCurrentUser = useFreshCallback(async () => {\n    const token = await getToken();\n    if (token) {\n      unregisterToken(token);\n      Logger.log('[usePushTokenRegistration]', 'unregistered token:', token);\n    }\n    refreshListener.current?.();\n  });\n\n  return { registerPushTokenForCurrentUser, unregisterPushTokenForCurrentUser };\n};\n\nexport default usePushTokenRegistration;\n"],"mappings":"AAAA,SAASA,MAAM,QAAQ,OAAO;AAC9B,SAASC,QAAQ,QAAQ,cAAc;AAEvC,SAASC,MAAM,EAAEC,gBAAgB,EAAEC,OAAO,QAAQ,uBAAuB;AAEzE,SAASC,kBAAkB,EAAEC,eAAe,QAAQ,cAAc;AAElE,MAAMC,wBAAwB,GAAGA,CAAA,KAAM;EACrC,MAAM;IAAEC;EAAI,CAAC,GAAGF,eAAe,EAAE;EACjC,MAAM;IAAEG;EAAoB,CAAC,GAAGJ,kBAAkB,EAAE;EAEpD,MAAMK,eAAe,GAAGV,MAAM,EAAc;EAC5C,MAAM,CAACW,aAAa,EAAEC,eAAe,EAAEC,QAAQ,CAAC,GAAGT,OAAO,CAAC,MAAM;IAC/D,OAAO,CACLH,QAAQ,CAACa,MAAM,CAAC;MACdC,GAAG,EAAGC,KAAa,IAAKR,GAAG,CAACS,mCAAmC,CAACD,KAAK,CAAC;MACtEE,OAAO,EAAGF,KAAa,IAAKR,GAAG,CAACW,kCAAkC,CAACH,KAAK;IAC1E,CAAC,CAAC,EACFf,QAAQ,CAACa,MAAM,CAAC;MACdC,GAAG,EAAGC,KAAa,IAAKR,GAAG,CAACY,qCAAqC,CAACJ,KAAK,CAAC;MACxEE,OAAO,EAAGF,KAAa,IAAKR,GAAG,CAACa,oCAAoC,CAACL,KAAK;IAC5E,CAAC,CAAC,EACFf,QAAQ,CAACa,MAAM,CAAC;MACdC,GAAG,EAAEN,mBAAmB,CAACa,YAAY;MACrCJ,OAAO,EAAET,mBAAmB,CAACc;IAC/B,CAAC,CAAC,CACH;EACH,CAAC,CAAC;EAEF,MAAMC,+BAA+B,GAAGrB,gBAAgB,CAAC,YAAY;IACnE;IACA,MAAMsB,aAAa,GAAG,MAAMhB,mBAAmB,CAACiB,iBAAiB,EAAE;IACnE,IAAI,CAACD,aAAa,EAAE;MAClB,MAAME,cAAc,GAAG,MAAMlB,mBAAmB,CAACmB,qBAAqB,EAAE;MACxE,IAAI,CAACD,cAAc,EAAE;QACnBzB,MAAM,CAAC2B,IAAI,CAAC,4BAA4B,EAAE,6BAA6B,CAAC;QACxE;MACF;IACF;;IAEA;IACA,MAAMb,KAAK,GAAG,MAAMH,QAAQ,EAAE;IAC9B,IAAIG,KAAK,EAAE;MACTd,MAAM,CAAC4B,GAAG,CAAC,4BAA4B,EAAE,mBAAmB,EAAEd,KAAK,CAAC;MACpEL,aAAa,CAACK,KAAK,CAAC;IACtB;;IAEA;IACAN,eAAe,CAACqB,OAAO,GAAGtB,mBAAmB,CAACuB,cAAc,CAACrB,aAAa,CAAC;EAC7E,CAAC,CAAC;EAEF,MAAMsB,iCAAiC,GAAG9B,gBAAgB,CAAC,YAAY;IAAA,IAAA+B,qBAAA;IACrE,MAAMlB,KAAK,GAAG,MAAMH,QAAQ,EAAE;IAC9B,IAAIG,KAAK,EAAE;MACTJ,eAAe,CAACI,KAAK,CAAC;MACtBd,MAAM,CAAC4B,GAAG,CAAC,4BAA4B,EAAE,qBAAqB,EAAEd,KAAK,CAAC;IACxE;IACA,CAAAkB,qBAAA,GAAAxB,eAAe,CAACqB,OAAO,cAAAG,qBAAA,uBAAvBA,qBAAA,CAAAC,IAAA,CAAAzB,eAAe,CAAY;EAC7B,CAAC,CAAC;EAEF,OAAO;IAAEc,+BAA+B;IAAES;EAAkC,CAAC;AAC/E,CAAC;AAED,eAAe1B,wBAAwB"}