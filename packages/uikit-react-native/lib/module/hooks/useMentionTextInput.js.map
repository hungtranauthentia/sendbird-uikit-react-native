{"version":3,"names":["useEffect","useRef","useState","Platform","replace","useFreshCallback","useSendbirdChat","useMentionTextInput","params","mentionManager","sbOptions","mentionedUsersRef","textInputRef","text","setText","selection","setSelection","start","end","shouldUseMentionedMessageTemplate","messageToEdit","uikit","groupChannel","channel","enableMention","_params$messageToEdit","_params$messageToEdit2","result","templateToTextAndMentionedUsers","mentionedMessageTemplate","mentionedUsers","current","mentionedText","_params$messageToEdit3","isUserMessage","message","onChangeText","_nextText","addedMentionedUser","prevText","nextText","offset","length","push","reconcileRangeOfMentionedUsers","filtered","lastSelection","removeMentionedUsersInSelection","Math","max","foundIndex","findIndex","it","rangeHelpers","overlaps","range","remainderLength","splice","onSelectionChange","e","nativeSelection","nativeEvent","setTimeout","mentionedUser","find","_textInputRef$current","selectionBlock","setNativeProps","OS","_textInputRef$current2"],"sources":["useMentionTextInput.ts"],"sourcesContent":["import { useEffect, useRef, useState } from 'react';\nimport type { NativeSyntheticEvent, TextInput, TextInputSelectionChangeEventData } from 'react-native';\nimport { Platform } from 'react-native';\n\nimport { SendbirdFileMessage, SendbirdUserMessage, replace, useFreshCallback } from '@sendbird/uikit-utils';\n\nimport type { MentionedUser } from '../types';\nimport { useSendbirdChat } from './useContext';\n\nconst useMentionTextInput = (params: { messageToEdit?: SendbirdUserMessage | SendbirdFileMessage }) => {\n  const { mentionManager, sbOptions } = useSendbirdChat();\n\n  const mentionedUsersRef = useRef<MentionedUser[]>([]);\n  const textInputRef = useRef<TextInput>();\n\n  const [text, setText] = useState('');\n  const [selection, setSelection] = useState({ start: 0, end: 0 });\n\n  // TODO: Refactor text edit logic more clearly\n  useEffect(() => {\n    if (\n      mentionManager.shouldUseMentionedMessageTemplate(\n        params.messageToEdit,\n        sbOptions.uikit.groupChannel.channel.enableMention,\n      )\n    ) {\n      const result = mentionManager.templateToTextAndMentionedUsers(\n        params.messageToEdit?.mentionedMessageTemplate ?? '',\n        params.messageToEdit?.mentionedUsers ?? [],\n      );\n\n      mentionedUsersRef.current = result.mentionedUsers;\n      setText(result.mentionedText);\n    } else {\n      mentionedUsersRef.current = [];\n      if (params.messageToEdit?.isUserMessage()) {\n        setText(params.messageToEdit.message);\n      }\n    }\n  }, [params.messageToEdit]);\n\n  const onChangeText = useFreshCallback((_nextText: string, addedMentionedUser?: MentionedUser) => {\n    const prevText = text;\n    let nextText = _nextText;\n    let offset = nextText.length - prevText.length;\n\n    // Text clear\n    if (nextText === '') {\n      mentionedUsersRef.current = [];\n    }\n    // Text add\n    else if (offset > 0) {\n      /** Add mentioned user **/\n      if (addedMentionedUser) mentionedUsersRef.current.push(addedMentionedUser);\n\n      /** Reconcile mentioned users range on the right side of the selection **/\n      mentionedUsersRef.current = mentionManager.reconcileRangeOfMentionedUsers(\n        offset,\n        selection.end,\n        mentionedUsersRef.current,\n      );\n    }\n    // Text remove\n    else if (offset < 0) {\n      // Ranged remove\n      if (selection.start !== selection.end) {\n        /** Filter mentioned users in selection range **/\n        const { filtered, lastSelection } = mentionManager.removeMentionedUsersInSelection(\n          selection,\n          mentionedUsersRef.current,\n        );\n\n        /** Reconcile mentioned users range on the right side of the selection **/\n        mentionedUsersRef.current = mentionManager.reconcileRangeOfMentionedUsers(\n          offset,\n          Math.max(selection.end, lastSelection),\n          filtered,\n        );\n      }\n      // Single remove\n      else {\n        /** Find mentioned user who ranges in removed selection **/\n        const foundIndex = mentionedUsersRef.current.findIndex((it) =>\n          mentionManager.rangeHelpers.overlaps(it.range, selection, 'underMore'),\n        );\n        /** If found, remove from the mentioned user list and remove remainder text **/\n        if (foundIndex > -1) {\n          const it = mentionedUsersRef.current[foundIndex];\n          const remainderLength = it.range.end - it.range.start + offset;\n\n          offset = -remainderLength + offset;\n          nextText = replace(nextText, it.range.start, it.range.start + remainderLength, '');\n\n          mentionedUsersRef.current.splice(foundIndex, 1);\n        }\n\n        /** Reconcile mentioned users range on the right side of the selection **/\n        mentionedUsersRef.current = mentionManager.reconcileRangeOfMentionedUsers(\n          offset,\n          selection.end,\n          mentionedUsersRef.current,\n        );\n      }\n    }\n\n    setText(nextText);\n  });\n\n  return {\n    textInputRef,\n    selection,\n    onSelectionChange: useFreshCallback((e: NativeSyntheticEvent<TextInputSelectionChangeEventData>) => {\n      const nativeSelection = { ...e.nativeEvent.selection };\n\n      // NOTE: To synchronize call onSelectionChange after onChangeText called on each platform.\n      setTimeout(() => {\n        const mentionedUser = mentionedUsersRef.current.find((it) =>\n          mentionManager.rangeHelpers.overlaps(it.range, nativeSelection),\n        );\n\n        // Selection should be blocked if changed into mentioned area\n        if (mentionedUser) {\n          const selectionBlock = { start: mentionedUser.range.start, end: mentionedUser.range.end };\n          textInputRef.current?.setNativeProps({ selection: selectionBlock });\n          // BUG: setNativeProps called again when invoked onChangeText\n          //  https://github.com/facebook/react-native/issues/33520\n          if (Platform.OS === 'android') {\n            setTimeout(() => {\n              textInputRef.current?.setNativeProps({ selection: { start: 0 } });\n            }, 250);\n          }\n          setSelection(selectionBlock);\n        } else {\n          setSelection(nativeSelection);\n        }\n      }, 10);\n    }),\n    text,\n    onChangeText,\n    mentionedUsers: mentionedUsersRef.current,\n  };\n};\n\nexport default useMentionTextInput;\n"],"mappings":"AAAA,SAASA,SAAS,EAAEC,MAAM,EAAEC,QAAQ,QAAQ,OAAO;AAEnD,SAASC,QAAQ,QAAQ,cAAc;AAEvC,SAAmDC,OAAO,EAAEC,gBAAgB,QAAQ,uBAAuB;AAG3G,SAASC,eAAe,QAAQ,cAAc;AAE9C,MAAMC,mBAAmB,GAAIC,MAAqE,IAAK;EACrG,MAAM;IAAEC,cAAc;IAAEC;EAAU,CAAC,GAAGJ,eAAe,EAAE;EAEvD,MAAMK,iBAAiB,GAAGV,MAAM,CAAkB,EAAE,CAAC;EACrD,MAAMW,YAAY,GAAGX,MAAM,EAAa;EAExC,MAAM,CAACY,IAAI,EAAEC,OAAO,CAAC,GAAGZ,QAAQ,CAAC,EAAE,CAAC;EACpC,MAAM,CAACa,SAAS,EAAEC,YAAY,CAAC,GAAGd,QAAQ,CAAC;IAAEe,KAAK,EAAE,CAAC;IAAEC,GAAG,EAAE;EAAE,CAAC,CAAC;;EAEhE;EACAlB,SAAS,CAAC,MAAM;IACd,IACES,cAAc,CAACU,iCAAiC,CAC9CX,MAAM,CAACY,aAAa,EACpBV,SAAS,CAACW,KAAK,CAACC,YAAY,CAACC,OAAO,CAACC,aAAa,CACnD,EACD;MAAA,IAAAC,qBAAA,EAAAC,sBAAA;MACA,MAAMC,MAAM,GAAGlB,cAAc,CAACmB,+BAA+B,CAC3D,EAAAH,qBAAA,GAAAjB,MAAM,CAACY,aAAa,cAAAK,qBAAA,uBAApBA,qBAAA,CAAsBI,wBAAwB,KAAI,EAAE,EACpD,EAAAH,sBAAA,GAAAlB,MAAM,CAACY,aAAa,cAAAM,sBAAA,uBAApBA,sBAAA,CAAsBI,cAAc,KAAI,EAAE,CAC3C;MAEDnB,iBAAiB,CAACoB,OAAO,GAAGJ,MAAM,CAACG,cAAc;MACjDhB,OAAO,CAACa,MAAM,CAACK,aAAa,CAAC;IAC/B,CAAC,MAAM;MAAA,IAAAC,sBAAA;MACLtB,iBAAiB,CAACoB,OAAO,GAAG,EAAE;MAC9B,KAAAE,sBAAA,GAAIzB,MAAM,CAACY,aAAa,cAAAa,sBAAA,eAApBA,sBAAA,CAAsBC,aAAa,EAAE,EAAE;QACzCpB,OAAO,CAACN,MAAM,CAACY,aAAa,CAACe,OAAO,CAAC;MACvC;IACF;EACF,CAAC,EAAE,CAAC3B,MAAM,CAACY,aAAa,CAAC,CAAC;EAE1B,MAAMgB,YAAY,GAAG/B,gBAAgB,CAAC,CAACgC,SAAiB,EAAEC,kBAAkC,KAAK;IAC/F,MAAMC,QAAQ,GAAG1B,IAAI;IACrB,IAAI2B,QAAQ,GAAGH,SAAS;IACxB,IAAII,MAAM,GAAGD,QAAQ,CAACE,MAAM,GAAGH,QAAQ,CAACG,MAAM;;IAE9C;IACA,IAAIF,QAAQ,KAAK,EAAE,EAAE;MACnB7B,iBAAiB,CAACoB,OAAO,GAAG,EAAE;IAChC;IACA;IAAA,KACK,IAAIU,MAAM,GAAG,CAAC,EAAE;MACnB;MACA,IAAIH,kBAAkB,EAAE3B,iBAAiB,CAACoB,OAAO,CAACY,IAAI,CAACL,kBAAkB,CAAC;;MAE1E;MACA3B,iBAAiB,CAACoB,OAAO,GAAGtB,cAAc,CAACmC,8BAA8B,CACvEH,MAAM,EACN1B,SAAS,CAACG,GAAG,EACbP,iBAAiB,CAACoB,OAAO,CAC1B;IACH;IACA;IAAA,KACK,IAAIU,MAAM,GAAG,CAAC,EAAE;MACnB;MACA,IAAI1B,SAAS,CAACE,KAAK,KAAKF,SAAS,CAACG,GAAG,EAAE;QACrC;QACA,MAAM;UAAE2B,QAAQ;UAAEC;QAAc,CAAC,GAAGrC,cAAc,CAACsC,+BAA+B,CAChFhC,SAAS,EACTJ,iBAAiB,CAACoB,OAAO,CAC1B;;QAED;QACApB,iBAAiB,CAACoB,OAAO,GAAGtB,cAAc,CAACmC,8BAA8B,CACvEH,MAAM,EACNO,IAAI,CAACC,GAAG,CAAClC,SAAS,CAACG,GAAG,EAAE4B,aAAa,CAAC,EACtCD,QAAQ,CACT;MACH;MACA;MAAA,KACK;QACH;QACA,MAAMK,UAAU,GAAGvC,iBAAiB,CAACoB,OAAO,CAACoB,SAAS,CAAEC,EAAE,IACxD3C,cAAc,CAAC4C,YAAY,CAACC,QAAQ,CAACF,EAAE,CAACG,KAAK,EAAExC,SAAS,EAAE,WAAW,CAAC,CACvE;QACD;QACA,IAAImC,UAAU,GAAG,CAAC,CAAC,EAAE;UACnB,MAAME,EAAE,GAAGzC,iBAAiB,CAACoB,OAAO,CAACmB,UAAU,CAAC;UAChD,MAAMM,eAAe,GAAGJ,EAAE,CAACG,KAAK,CAACrC,GAAG,GAAGkC,EAAE,CAACG,KAAK,CAACtC,KAAK,GAAGwB,MAAM;UAE9DA,MAAM,GAAG,CAACe,eAAe,GAAGf,MAAM;UAClCD,QAAQ,GAAGpC,OAAO,CAACoC,QAAQ,EAAEY,EAAE,CAACG,KAAK,CAACtC,KAAK,EAAEmC,EAAE,CAACG,KAAK,CAACtC,KAAK,GAAGuC,eAAe,EAAE,EAAE,CAAC;UAElF7C,iBAAiB,CAACoB,OAAO,CAAC0B,MAAM,CAACP,UAAU,EAAE,CAAC,CAAC;QACjD;;QAEA;QACAvC,iBAAiB,CAACoB,OAAO,GAAGtB,cAAc,CAACmC,8BAA8B,CACvEH,MAAM,EACN1B,SAAS,CAACG,GAAG,EACbP,iBAAiB,CAACoB,OAAO,CAC1B;MACH;IACF;IAEAjB,OAAO,CAAC0B,QAAQ,CAAC;EACnB,CAAC,CAAC;EAEF,OAAO;IACL5B,YAAY;IACZG,SAAS;IACT2C,iBAAiB,EAAErD,gBAAgB,CAAEsD,CAA0D,IAAK;MAClG,MAAMC,eAAe,GAAG;QAAE,GAAGD,CAAC,CAACE,WAAW,CAAC9C;MAAU,CAAC;;MAEtD;MACA+C,UAAU,CAAC,MAAM;QACf,MAAMC,aAAa,GAAGpD,iBAAiB,CAACoB,OAAO,CAACiC,IAAI,CAAEZ,EAAE,IACtD3C,cAAc,CAAC4C,YAAY,CAACC,QAAQ,CAACF,EAAE,CAACG,KAAK,EAAEK,eAAe,CAAC,CAChE;;QAED;QACA,IAAIG,aAAa,EAAE;UAAA,IAAAE,qBAAA;UACjB,MAAMC,cAAc,GAAG;YAAEjD,KAAK,EAAE8C,aAAa,CAACR,KAAK,CAACtC,KAAK;YAAEC,GAAG,EAAE6C,aAAa,CAACR,KAAK,CAACrC;UAAI,CAAC;UACzF,CAAA+C,qBAAA,GAAArD,YAAY,CAACmB,OAAO,cAAAkC,qBAAA,uBAApBA,qBAAA,CAAsBE,cAAc,CAAC;YAAEpD,SAAS,EAAEmD;UAAe,CAAC,CAAC;UACnE;UACA;UACA,IAAI/D,QAAQ,CAACiE,EAAE,KAAK,SAAS,EAAE;YAC7BN,UAAU,CAAC,MAAM;cAAA,IAAAO,sBAAA;cACf,CAAAA,sBAAA,GAAAzD,YAAY,CAACmB,OAAO,cAAAsC,sBAAA,uBAApBA,sBAAA,CAAsBF,cAAc,CAAC;gBAAEpD,SAAS,EAAE;kBAAEE,KAAK,EAAE;gBAAE;cAAE,CAAC,CAAC;YACnE,CAAC,EAAE,GAAG,CAAC;UACT;UACAD,YAAY,CAACkD,cAAc,CAAC;QAC9B,CAAC,MAAM;UACLlD,YAAY,CAAC4C,eAAe,CAAC;QAC/B;MACF,CAAC,EAAE,EAAE,CAAC;IACR,CAAC,CAAC;IACF/C,IAAI;IACJuB,YAAY;IACZN,cAAc,EAAEnB,iBAAiB,CAACoB;EACpC,CAAC;AACH,CAAC;AAED,eAAexB,mBAAmB"}