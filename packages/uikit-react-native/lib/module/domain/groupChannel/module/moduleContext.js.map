{"version":3,"names":["React","createContext","useCallback","useRef","useState","useChannelHandler","Logger","NOOP","getGroupChannelChatAvailableState","isDifferentChannel","useFreshCallback","useUniqHandlerId","ProviderLayout","MESSAGE_FOCUS_ANIMATION_DELAY","useLocalization","useSendbirdChat","GroupChannelContexts","Fragment","headerTitle","channel","setMessageToEdit","setMessageToReply","TypingIndicator","typingUsers","PubSub","publish","subscribe","MessageList","flatListRef","current","scrollToMessage","lazyScrollToBottom","lazyScrollToIndex","GroupChannelContextsProvider","_ref","children","enableTypingIndicator","keyboardAvoidOffset","groupChannelPubSub","messages","onUpdateSearchItem","Error","handlerId","STRINGS","currentUser","sdk","setTypingUsers","messageToEdit","messageToReply","useScrollActions","updateInputMode","mode","message","undefined","onMessageDeleted","_","messageId","onChannelFrozen","frozenChannel","url","isGroupChannel","frozen","onUserMuted","mutedChannel","user","_sdk$currentUser","userId","onTypingStatusUpdated","eventChannel","getTypingUsers","createElement","Provider","value","GROUP_CHANNEL","HEADER_TITLE","params","logFlatListRefWarning","setTimeout","_flatListRef$current","scrollToOffset","offset","animated","timeout","_flatListRef$current2","scrollToIndex","index","viewPosition","options","foundMessageIndex","findIndex","it","isIncludedInList","focusAnimated","startingPoint","createdAt","warn"],"sources":["moduleContext.tsx"],"sourcesContent":["import React, { createContext, useCallback, useRef, useState } from 'react';\nimport type { FlatList } from 'react-native';\n\nimport { useChannelHandler } from '@sendbird/uikit-chat-hooks';\nimport {\n  ContextValue,\n  Logger,\n  NOOP,\n  SendbirdFileMessage,\n  SendbirdGroupChannel,\n  SendbirdMessage,\n  SendbirdUser,\n  SendbirdUserMessage,\n  getGroupChannelChatAvailableState,\n  isDifferentChannel,\n  useFreshCallback,\n  useUniqHandlerId,\n} from '@sendbird/uikit-utils';\n\nimport ProviderLayout from '../../../components/ProviderLayout';\nimport { MESSAGE_FOCUS_ANIMATION_DELAY } from '../../../constants';\nimport { useLocalization, useSendbirdChat } from '../../../hooks/useContext';\nimport type { PubSub } from '../../../utils/pubsub';\nimport type { GroupChannelContextsType, GroupChannelModule, GroupChannelPubSubContextPayload } from '../types';\nimport { GroupChannelProps } from '../types';\n\nexport const GroupChannelContexts: GroupChannelContextsType = {\n  Fragment: createContext({\n    headerTitle: '',\n    channel: {} as SendbirdGroupChannel,\n    setMessageToEdit: NOOP,\n    setMessageToReply: NOOP,\n  }),\n  TypingIndicator: createContext({\n    typingUsers: [] as SendbirdUser[],\n  }),\n  PubSub: createContext({\n    publish: NOOP,\n    subscribe: () => NOOP,\n  } as PubSub<GroupChannelPubSubContextPayload>),\n  MessageList: createContext({\n    flatListRef: { current: null },\n    scrollToMessage: () => false,\n    lazyScrollToBottom: () => {\n      // noop\n    },\n    lazyScrollToIndex: () => {\n      // noop\n    },\n  } as MessageListContextValue),\n};\n\nexport const GroupChannelContextsProvider: GroupChannelModule['Provider'] = ({\n  children,\n  channel,\n  enableTypingIndicator,\n  keyboardAvoidOffset = 0,\n  groupChannelPubSub,\n  messages,\n  onUpdateSearchItem,\n}) => {\n  if (!channel) throw new Error('GroupChannel is not provided to GroupChannelModule');\n\n  const handlerId = useUniqHandlerId('GroupChannelContextsProvider');\n  const { STRINGS } = useLocalization();\n  const { currentUser, sdk } = useSendbirdChat();\n\n  const [typingUsers, setTypingUsers] = useState<SendbirdUser[]>([]);\n  const [messageToEdit, setMessageToEdit] = useState<SendbirdUserMessage | SendbirdFileMessage>();\n  const [messageToReply, setMessageToReply] = useState<SendbirdUserMessage | SendbirdFileMessage>();\n\n  const { flatListRef, lazyScrollToIndex, lazyScrollToBottom, scrollToMessage } = useScrollActions({\n    messages,\n    onUpdateSearchItem,\n  });\n\n  const updateInputMode = (mode: 'send' | 'edit' | 'reply', message?: SendbirdUserMessage | SendbirdFileMessage) => {\n    if (mode === 'send' || !message) {\n      setMessageToEdit(undefined);\n      setMessageToReply(undefined);\n      return;\n    } else if (mode === 'edit') {\n      setMessageToEdit(message);\n      setMessageToReply(undefined);\n      return;\n    } else if (mode === 'reply') {\n      setMessageToEdit(undefined);\n      setMessageToReply(message);\n      return;\n    }\n  };\n\n  useChannelHandler(sdk, handlerId, {\n    onMessageDeleted(_, messageId) {\n      if (messageToReply?.messageId === messageId) {\n        setMessageToReply(undefined);\n      }\n    },\n    onChannelFrozen(frozenChannel) {\n      if (frozenChannel.url === channel.url) {\n        if (frozenChannel.isGroupChannel() && getGroupChannelChatAvailableState(channel).frozen) {\n          setMessageToReply(undefined);\n        }\n      }\n    },\n    onUserMuted(mutedChannel, user) {\n      if (mutedChannel.url === channel.url && user.userId === sdk.currentUser?.userId) {\n        setMessageToReply(undefined);\n      }\n    },\n    onTypingStatusUpdated(eventChannel) {\n      if (isDifferentChannel(channel, eventChannel)) return;\n      if (!enableTypingIndicator) return;\n      setTypingUsers(eventChannel.getTypingUsers());\n    },\n  });\n\n  return (\n    <ProviderLayout>\n      <GroupChannelContexts.Fragment.Provider\n        value={{\n          headerTitle: STRINGS.GROUP_CHANNEL.HEADER_TITLE(currentUser?.userId ?? '', channel),\n          channel,\n          keyboardAvoidOffset,\n          messageToEdit,\n          setMessageToEdit: useCallback((message) => updateInputMode('edit', message), []),\n          messageToReply,\n          setMessageToReply: useCallback((message) => updateInputMode('reply', message), []),\n        }}\n      >\n        <GroupChannelContexts.PubSub.Provider value={groupChannelPubSub}>\n          <GroupChannelContexts.TypingIndicator.Provider value={{ typingUsers }}>\n            <GroupChannelContexts.MessageList.Provider\n              value={{\n                flatListRef,\n                scrollToMessage,\n                lazyScrollToIndex,\n                lazyScrollToBottom,\n              }}\n            >\n              {children}\n            </GroupChannelContexts.MessageList.Provider>\n          </GroupChannelContexts.TypingIndicator.Provider>\n        </GroupChannelContexts.PubSub.Provider>\n      </GroupChannelContexts.Fragment.Provider>\n    </ProviderLayout>\n  );\n};\n\ntype MessageListContextValue = ContextValue<GroupChannelContextsType['MessageList']>;\nconst useScrollActions = (params: Pick<GroupChannelProps['Provider'], 'messages' | 'onUpdateSearchItem'>) => {\n  const { messages, onUpdateSearchItem } = params;\n  const flatListRef = useRef<FlatList<SendbirdMessage>>(null);\n\n  // FIXME: Workaround, should run after data has been applied to UI.\n  const lazyScrollToBottom = useFreshCallback<MessageListContextValue['lazyScrollToIndex']>((params) => {\n    if (!flatListRef.current) {\n      logFlatListRefWarning();\n      return;\n    }\n\n    setTimeout(() => {\n      flatListRef.current?.scrollToOffset({ offset: 0, animated: params?.animated ?? false });\n    }, params?.timeout ?? 0);\n  });\n\n  // FIXME: Workaround, should run after data has been applied to UI.\n  const lazyScrollToIndex = useFreshCallback<MessageListContextValue['lazyScrollToIndex']>((params) => {\n    if (!flatListRef.current) {\n      logFlatListRefWarning();\n      return;\n    }\n\n    setTimeout(() => {\n      flatListRef.current?.scrollToIndex({\n        index: params?.index ?? 0,\n        animated: params?.animated ?? false,\n        viewPosition: params?.viewPosition ?? 0.5,\n      });\n    }, params?.timeout ?? 0);\n  });\n\n  const scrollToMessage = useFreshCallback<MessageListContextValue['scrollToMessage']>((messageId, options) => {\n    if (!flatListRef.current) {\n      logFlatListRefWarning();\n      return false;\n    }\n\n    const foundMessageIndex = messages.findIndex((it) => it.messageId === messageId);\n    const isIncludedInList = foundMessageIndex > -1;\n\n    if (isIncludedInList) {\n      if (options?.focusAnimated) {\n        setTimeout(\n          () => onUpdateSearchItem({ startingPoint: messages[foundMessageIndex].createdAt }),\n          MESSAGE_FOCUS_ANIMATION_DELAY,\n        );\n      }\n      lazyScrollToIndex({\n        index: foundMessageIndex,\n        animated: true,\n        timeout: 0,\n        viewPosition: options?.viewPosition,\n      });\n      return true;\n    } else {\n      return false;\n    }\n  });\n\n  return {\n    flatListRef,\n    lazyScrollToIndex,\n    lazyScrollToBottom,\n    scrollToMessage,\n  };\n};\n\nconst logFlatListRefWarning = () => {\n  Logger.warn(\n    'Cannot find flatListRef.current, please render FlatList and pass the flatListRef' +\n      'or please try again after FlatList has been rendered.',\n  );\n};\n"],"mappings":"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"}