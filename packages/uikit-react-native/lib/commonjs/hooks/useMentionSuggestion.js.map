{"version":3,"names":["_react","require","_uikitChatHooks","_uikitUtils","_useContext","useMentionSuggestion","params","text","selection","channel","mentionedUsers","freshChannel","setFreshChannel","useState","useAsyncEffect","refresh","url","id","useUniqHandlerId","useChannelHandler","sdk","onUserJoined","eventChannel","isDifferentChannel","onUserLeft","onUserBanned","isGroupChannel","mentionManager","currentUser","useSendbirdChat","members","setMembers","searchStringRangeRef","useRef","start","end","searchLimitedRef","updateSearchStringRange","selectionIndex","searchString","current","getSearchStringRangeInText","updateSearchLimited","mentionCount","mentionLimit","resetRefs","fetchMembers","selectionRanged","selectionContainsMentionedUser","some","it","rangeHelpers","overlaps","range","isTriggered","isValidSearchString","getSearchString","limited","length","config","isSuper","createMemberListQuery","nicknameStartsWithFilter","limit","suggestionLimit","next","then","filter","member","userId","slice","sort","a","b","_a$nickname","nickname","localeCompare","_member$nickname","toLowerCase","startsWith","isActive","useDebounceEffect","catch","debounceMills","reset","useCallback","searchStringRange","searchLimited","_default","exports","default"],"sources":["useMentionSuggestion.ts"],"sourcesContent":["import { useCallback, useRef, useState } from 'react';\n\nimport { useChannelHandler } from '@sendbird/uikit-chat-hooks';\nimport type { SendbirdChatSDK, SendbirdGroupChannel, SendbirdMember, SendbirdUser } from '@sendbird/uikit-utils';\nimport { isDifferentChannel, useAsyncEffect, useDebounceEffect, useUniqHandlerId } from '@sendbird/uikit-utils';\n\nimport { useSendbirdChat } from '../hooks/useContext';\nimport type { Range } from '../types';\n\nconst useMentionSuggestion = (params: {\n  text: string;\n  selection: Range;\n  mentionedUsers: { user: SendbirdUser; range: Range }[];\n  sdk: SendbirdChatSDK;\n  channel: SendbirdGroupChannel;\n}) => {\n  const { text, selection, channel, mentionedUsers } = params;\n\n  const [freshChannel, setFreshChannel] = useState(channel);\n\n  useAsyncEffect(async () => {\n    setFreshChannel(await channel.refresh());\n  }, [channel.url]);\n\n  const id = useUniqHandlerId('useMentionSuggestion');\n\n  useChannelHandler(params.sdk, id, {\n    onUserJoined(eventChannel) {\n      if (isDifferentChannel(eventChannel, channel)) return;\n      setFreshChannel(eventChannel);\n    },\n    onUserLeft(eventChannel) {\n      if (isDifferentChannel(eventChannel, channel)) return;\n      setFreshChannel(eventChannel);\n    },\n    onUserBanned(eventChannel) {\n      if (isDifferentChannel(eventChannel, channel)) return;\n      if (!eventChannel.isGroupChannel()) return;\n      setFreshChannel(eventChannel);\n    },\n  });\n\n  const { mentionManager, currentUser } = useSendbirdChat();\n  const [members, setMembers] = useState<SendbirdMember[]>([]);\n\n  const searchStringRangeRef = useRef<Range>({ start: 0, end: 0 });\n  const searchLimitedRef = useRef(false);\n\n  const updateSearchStringRange = (selectionIndex: number, searchString: string) => {\n    searchStringRangeRef.current = mentionManager.getSearchStringRangeInText(selectionIndex, searchString);\n    return searchStringRangeRef.current;\n  };\n  const updateSearchLimited = (mentionCount: number, mentionLimit: number) => {\n    searchLimitedRef.current = mentionCount >= mentionLimit;\n    return searchLimitedRef.current;\n  };\n  const resetRefs = () => {\n    searchLimitedRef.current = false;\n    searchStringRangeRef.current = { start: 0, end: 0 };\n  };\n\n  const fetchMembers = async (): Promise<SendbirdMember[]> => {\n    resetRefs();\n\n    const selectionRanged = selection.start !== selection.end;\n    if (selectionRanged) return [];\n\n    const selectionContainsMentionedUser = mentionedUsers.some((it) =>\n      mentionManager.rangeHelpers.overlaps(it.range, selection, 'underMore'),\n    );\n    if (selectionContainsMentionedUser) return [];\n\n    const { isTriggered, isValidSearchString, searchString } = mentionManager.getSearchString(text, selection.start);\n    if (!isTriggered() || !isValidSearchString()) return [];\n\n    const limited = updateSearchLimited(mentionedUsers.length, mentionManager.config.mentionLimit);\n    if (limited) return [];\n\n    updateSearchStringRange(selection.start, searchString);\n\n    if (freshChannel.isSuper) {\n      return freshChannel\n        .createMemberListQuery({\n          nicknameStartsWithFilter: searchString,\n          limit: mentionManager.config.suggestionLimit + 1,\n        })\n        .next()\n        .then((members) => members.filter((member) => member.userId !== currentUser?.userId))\n        .then((members) => members.slice(0, mentionManager.config.suggestionLimit));\n    } else {\n      return freshChannel.members\n        .sort((a, b) => a.nickname?.localeCompare(b.nickname))\n        .filter(\n          (member) =>\n            member.nickname?.toLowerCase().startsWith(searchString.toLowerCase()) &&\n            member.userId !== currentUser?.userId &&\n            member.isActive,\n        )\n        .slice(0, mentionManager.config.suggestionLimit);\n    }\n  };\n\n  useDebounceEffect(\n    () => {\n      return fetchMembers()\n        .then(setMembers)\n        .catch(() => setMembers([]));\n    },\n    mentionManager.config.debounceMills,\n    [text, selection],\n  );\n\n  return {\n    members,\n    reset: useCallback(() => setMembers([]), []),\n    searchStringRange: searchStringRangeRef.current,\n    searchLimited: searchLimitedRef.current,\n  };\n};\n\nexport default useMentionSuggestion;\n"],"mappings":"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"}