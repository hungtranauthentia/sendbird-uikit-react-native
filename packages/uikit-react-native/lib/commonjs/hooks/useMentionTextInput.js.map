{"version":3,"names":["_react","require","_reactNative","_uikitUtils","_useContext","useMentionTextInput","params","mentionManager","sbOptions","useSendbirdChat","mentionedUsersRef","useRef","textInputRef","text","setText","useState","selection","setSelection","start","end","useEffect","shouldUseMentionedMessageTemplate","messageToEdit","uikit","groupChannel","channel","enableMention","_params$messageToEdit","_params$messageToEdit2","result","templateToTextAndMentionedUsers","mentionedMessageTemplate","mentionedUsers","current","mentionedText","_params$messageToEdit3","isUserMessage","message","onChangeText","useFreshCallback","_nextText","addedMentionedUser","prevText","nextText","offset","length","push","reconcileRangeOfMentionedUsers","filtered","lastSelection","removeMentionedUsersInSelection","Math","max","foundIndex","findIndex","it","rangeHelpers","overlaps","range","remainderLength","replace","splice","onSelectionChange","e","nativeSelection","nativeEvent","setTimeout","mentionedUser","find","_textInputRef$current","selectionBlock","setNativeProps","Platform","OS","_textInputRef$current2","_default","exports","default"],"sources":["useMentionTextInput.ts"],"sourcesContent":["import { useEffect, useRef, useState } from 'react';\nimport type { NativeSyntheticEvent, TextInput, TextInputSelectionChangeEventData } from 'react-native';\nimport { Platform } from 'react-native';\n\nimport { SendbirdFileMessage, SendbirdUserMessage, replace, useFreshCallback } from '@sendbird/uikit-utils';\n\nimport type { MentionedUser } from '../types';\nimport { useSendbirdChat } from './useContext';\n\nconst useMentionTextInput = (params: { messageToEdit?: SendbirdUserMessage | SendbirdFileMessage }) => {\n  const { mentionManager, sbOptions } = useSendbirdChat();\n\n  const mentionedUsersRef = useRef<MentionedUser[]>([]);\n  const textInputRef = useRef<TextInput>();\n\n  const [text, setText] = useState('');\n  const [selection, setSelection] = useState({ start: 0, end: 0 });\n\n  // TODO: Refactor text edit logic more clearly\n  useEffect(() => {\n    if (\n      mentionManager.shouldUseMentionedMessageTemplate(\n        params.messageToEdit,\n        sbOptions.uikit.groupChannel.channel.enableMention,\n      )\n    ) {\n      const result = mentionManager.templateToTextAndMentionedUsers(\n        params.messageToEdit?.mentionedMessageTemplate ?? '',\n        params.messageToEdit?.mentionedUsers ?? [],\n      );\n\n      mentionedUsersRef.current = result.mentionedUsers;\n      setText(result.mentionedText);\n    } else {\n      mentionedUsersRef.current = [];\n      if (params.messageToEdit?.isUserMessage()) {\n        setText(params.messageToEdit.message);\n      }\n    }\n  }, [params.messageToEdit]);\n\n  const onChangeText = useFreshCallback((_nextText: string, addedMentionedUser?: MentionedUser) => {\n    const prevText = text;\n    let nextText = _nextText;\n    let offset = nextText.length - prevText.length;\n\n    // Text clear\n    if (nextText === '') {\n      mentionedUsersRef.current = [];\n    }\n    // Text add\n    else if (offset > 0) {\n      /** Add mentioned user **/\n      if (addedMentionedUser) mentionedUsersRef.current.push(addedMentionedUser);\n\n      /** Reconcile mentioned users range on the right side of the selection **/\n      mentionedUsersRef.current = mentionManager.reconcileRangeOfMentionedUsers(\n        offset,\n        selection.end,\n        mentionedUsersRef.current,\n      );\n    }\n    // Text remove\n    else if (offset < 0) {\n      // Ranged remove\n      if (selection.start !== selection.end) {\n        /** Filter mentioned users in selection range **/\n        const { filtered, lastSelection } = mentionManager.removeMentionedUsersInSelection(\n          selection,\n          mentionedUsersRef.current,\n        );\n\n        /** Reconcile mentioned users range on the right side of the selection **/\n        mentionedUsersRef.current = mentionManager.reconcileRangeOfMentionedUsers(\n          offset,\n          Math.max(selection.end, lastSelection),\n          filtered,\n        );\n      }\n      // Single remove\n      else {\n        /** Find mentioned user who ranges in removed selection **/\n        const foundIndex = mentionedUsersRef.current.findIndex((it) =>\n          mentionManager.rangeHelpers.overlaps(it.range, selection, 'underMore'),\n        );\n        /** If found, remove from the mentioned user list and remove remainder text **/\n        if (foundIndex > -1) {\n          const it = mentionedUsersRef.current[foundIndex];\n          const remainderLength = it.range.end - it.range.start + offset;\n\n          offset = -remainderLength + offset;\n          nextText = replace(nextText, it.range.start, it.range.start + remainderLength, '');\n\n          mentionedUsersRef.current.splice(foundIndex, 1);\n        }\n\n        /** Reconcile mentioned users range on the right side of the selection **/\n        mentionedUsersRef.current = mentionManager.reconcileRangeOfMentionedUsers(\n          offset,\n          selection.end,\n          mentionedUsersRef.current,\n        );\n      }\n    }\n\n    setText(nextText);\n  });\n\n  return {\n    textInputRef,\n    selection,\n    onSelectionChange: useFreshCallback((e: NativeSyntheticEvent<TextInputSelectionChangeEventData>) => {\n      const nativeSelection = { ...e.nativeEvent.selection };\n\n      // NOTE: To synchronize call onSelectionChange after onChangeText called on each platform.\n      setTimeout(() => {\n        const mentionedUser = mentionedUsersRef.current.find((it) =>\n          mentionManager.rangeHelpers.overlaps(it.range, nativeSelection),\n        );\n\n        // Selection should be blocked if changed into mentioned area\n        if (mentionedUser) {\n          const selectionBlock = { start: mentionedUser.range.start, end: mentionedUser.range.end };\n          textInputRef.current?.setNativeProps({ selection: selectionBlock });\n          // BUG: setNativeProps called again when invoked onChangeText\n          //  https://github.com/facebook/react-native/issues/33520\n          if (Platform.OS === 'android') {\n            setTimeout(() => {\n              textInputRef.current?.setNativeProps({ selection: { start: 0 } });\n            }, 250);\n          }\n          setSelection(selectionBlock);\n        } else {\n          setSelection(nativeSelection);\n        }\n      }, 10);\n    }),\n    text,\n    onChangeText,\n    mentionedUsers: mentionedUsersRef.current,\n  };\n};\n\nexport default useMentionTextInput;\n"],"mappings":"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"}