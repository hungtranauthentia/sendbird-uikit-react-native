{"version":3,"names":["_react","require","_reactNative","_uikitUtils","_useContext","usePushTokenRegistration","sdk","useSendbirdChat","notificationService","usePlatformService","refreshListener","useRef","registerToken","unregisterToken","getToken","useIIFE","Platform","select","ios","token","registerAPNSPushTokenForCurrentUser","default","registerFCMPushTokenForCurrentUser","unregisterAPNSPushTokenForCurrentUser","unregisterFCMPushTokenForCurrentUser","getAPNSToken","getFCMToken","registerPushTokenForCurrentUser","useFreshCallback","hasPermission","hasPushPermission","pushPermission","requestPushPermission","Logger","warn","log","current","onTokenRefresh","unregisterPushTokenForCurrentUser","_refreshListener$curr","call","_default","exports"],"sources":["usePushTokenRegistration.ts"],"sourcesContent":["import { useRef } from 'react';\nimport { Platform } from 'react-native';\n\nimport { Logger, useFreshCallback, useIIFE } from '@sendbird/uikit-utils';\n\nimport { usePlatformService, useSendbirdChat } from './useContext';\n\nconst usePushTokenRegistration = () => {\n  const { sdk } = useSendbirdChat();\n  const { notificationService } = usePlatformService();\n\n  const refreshListener = useRef<() => void>();\n  const [registerToken, unregisterToken, getToken] = useIIFE(() => {\n    return [\n      Platform.select({\n        ios: (token: string) => sdk.registerAPNSPushTokenForCurrentUser(token),\n        default: (token: string) => sdk.registerFCMPushTokenForCurrentUser(token),\n      }),\n      Platform.select({\n        ios: (token: string) => sdk.unregisterAPNSPushTokenForCurrentUser(token),\n        default: (token: string) => sdk.unregisterFCMPushTokenForCurrentUser(token),\n      }),\n      Platform.select({\n        ios: notificationService.getAPNSToken,\n        default: notificationService.getFCMToken,\n      }),\n    ];\n  });\n\n  const registerPushTokenForCurrentUser = useFreshCallback(async () => {\n    // Check and request push permission\n    const hasPermission = await notificationService.hasPushPermission();\n    if (!hasPermission) {\n      const pushPermission = await notificationService.requestPushPermission();\n      if (!pushPermission) {\n        Logger.warn('[usePushTokenRegistration]', 'Not granted push permission');\n        return;\n      }\n    }\n\n    // Register device token\n    const token = await getToken();\n    if (token) {\n      Logger.log('[usePushTokenRegistration]', 'registered token:', token);\n      registerToken(token);\n    }\n\n    // Remove listener\n    refreshListener.current = notificationService.onTokenRefresh(registerToken);\n  });\n\n  const unregisterPushTokenForCurrentUser = useFreshCallback(async () => {\n    const token = await getToken();\n    if (token) {\n      unregisterToken(token);\n      Logger.log('[usePushTokenRegistration]', 'unregistered token:', token);\n    }\n    refreshListener.current?.();\n  });\n\n  return { registerPushTokenForCurrentUser, unregisterPushTokenForCurrentUser };\n};\n\nexport default usePushTokenRegistration;\n"],"mappings":";;;;;;AAAA,IAAAA,MAAA,GAAAC,OAAA;AACA,IAAAC,YAAA,GAAAD,OAAA;AAEA,IAAAE,WAAA,GAAAF,OAAA;AAEA,IAAAG,WAAA,GAAAH,OAAA;AAEA,MAAMI,wBAAwB,GAAGA,CAAA,KAAM;EACrC,MAAM;IAAEC;EAAI,CAAC,GAAG,IAAAC,2BAAe,GAAE;EACjC,MAAM;IAAEC;EAAoB,CAAC,GAAG,IAAAC,8BAAkB,GAAE;EAEpD,MAAMC,eAAe,GAAG,IAAAC,aAAM,GAAc;EAC5C,MAAM,CAACC,aAAa,EAAEC,eAAe,EAAEC,QAAQ,CAAC,GAAG,IAAAC,mBAAO,EAAC,MAAM;IAC/D,OAAO,CACLC,qBAAQ,CAACC,MAAM,CAAC;MACdC,GAAG,EAAGC,KAAa,IAAKb,GAAG,CAACc,mCAAmC,CAACD,KAAK,CAAC;MACtEE,OAAO,EAAGF,KAAa,IAAKb,GAAG,CAACgB,kCAAkC,CAACH,KAAK;IAC1E,CAAC,CAAC,EACFH,qBAAQ,CAACC,MAAM,CAAC;MACdC,GAAG,EAAGC,KAAa,IAAKb,GAAG,CAACiB,qCAAqC,CAACJ,KAAK,CAAC;MACxEE,OAAO,EAAGF,KAAa,IAAKb,GAAG,CAACkB,oCAAoC,CAACL,KAAK;IAC5E,CAAC,CAAC,EACFH,qBAAQ,CAACC,MAAM,CAAC;MACdC,GAAG,EAAEV,mBAAmB,CAACiB,YAAY;MACrCJ,OAAO,EAAEb,mBAAmB,CAACkB;IAC/B,CAAC,CAAC,CACH;EACH,CAAC,CAAC;EAEF,MAAMC,+BAA+B,GAAG,IAAAC,4BAAgB,EAAC,YAAY;IACnE;IACA,MAAMC,aAAa,GAAG,MAAMrB,mBAAmB,CAACsB,iBAAiB,EAAE;IACnE,IAAI,CAACD,aAAa,EAAE;MAClB,MAAME,cAAc,GAAG,MAAMvB,mBAAmB,CAACwB,qBAAqB,EAAE;MACxE,IAAI,CAACD,cAAc,EAAE;QACnBE,kBAAM,CAACC,IAAI,CAAC,4BAA4B,EAAE,6BAA6B,CAAC;QACxE;MACF;IACF;;IAEA;IACA,MAAMf,KAAK,GAAG,MAAML,QAAQ,EAAE;IAC9B,IAAIK,KAAK,EAAE;MACTc,kBAAM,CAACE,GAAG,CAAC,4BAA4B,EAAE,mBAAmB,EAAEhB,KAAK,CAAC;MACpEP,aAAa,CAACO,KAAK,CAAC;IACtB;;IAEA;IACAT,eAAe,CAAC0B,OAAO,GAAG5B,mBAAmB,CAAC6B,cAAc,CAACzB,aAAa,CAAC;EAC7E,CAAC,CAAC;EAEF,MAAM0B,iCAAiC,GAAG,IAAAV,4BAAgB,EAAC,YAAY;IAAA,IAAAW,qBAAA;IACrE,MAAMpB,KAAK,GAAG,MAAML,QAAQ,EAAE;IAC9B,IAAIK,KAAK,EAAE;MACTN,eAAe,CAACM,KAAK,CAAC;MACtBc,kBAAM,CAACE,GAAG,CAAC,4BAA4B,EAAE,qBAAqB,EAAEhB,KAAK,CAAC;IACxE;IACA,CAAAoB,qBAAA,GAAA7B,eAAe,CAAC0B,OAAO,cAAAG,qBAAA,uBAAvBA,qBAAA,CAAAC,IAAA,CAAA9B,eAAe,CAAY;EAC7B,CAAC,CAAC;EAEF,OAAO;IAAEiB,+BAA+B;IAAEW;EAAkC,CAAC;AAC/E,CAAC;AAAC,IAAAG,QAAA,GAEapC,wBAAwB;AAAAqC,OAAA,CAAArB,OAAA,GAAAoB,QAAA"}