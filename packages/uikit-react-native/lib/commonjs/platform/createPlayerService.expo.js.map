{"version":3,"names":["_uikitUtils","require","_expoPermissionGranted","_interopRequireDefault","obj","__esModule","default","_defineProperty","key","value","_toPropertyKey","Object","defineProperty","enumerable","configurable","writable","arg","_toPrimitive","String","input","hint","prim","Symbol","toPrimitive","undefined","res","call","TypeError","Number","createExpoPlayerService","_ref","avModule","sound","Audio","Sound","VoicePlayer","constructor","Set","state","stateSubscribers","forEach","callback","setProgressUpdateIntervalAsync","setOnPlaybackStatusUpdate","status","isLoaded","didJustFinish","stop","isPlaying","playbackSubscribers","currentTime","positionMillis","duration","durationMillis","stopped","getPermissionsAsync","expoPermissionGranted","requestPermissionsAsync","add","delete","uri","setState","loadAsync","shouldPlay","matchesOneOf","prepare","setListener","playAsync","e","removeListener","pauseAsync","stopAsync","unloadAsync","clear","time","playFromPositionAsync","_default","exports"],"sources":["createPlayerService.expo.tsx"],"sourcesContent":["import type * as ExpoAV from 'expo-av';\n\nimport { matchesOneOf } from '@sendbird/uikit-utils';\n\nimport expoPermissionGranted from '../utils/expoPermissionGranted';\nimport type { PlayerServiceInterface, Unsubscribe } from './types';\n\ntype Modules = {\n  avModule: typeof ExpoAV;\n};\ntype PlaybackListener = Parameters<PlayerServiceInterface['addPlaybackListener']>[number];\ntype StateListener = Parameters<PlayerServiceInterface['addStateListener']>[number];\nconst createExpoPlayerService = ({ avModule }: Modules): PlayerServiceInterface => {\n  const sound = new avModule.Audio.Sound();\n\n  class VoicePlayer implements PlayerServiceInterface {\n    uri?: string;\n    state: PlayerServiceInterface['state'] = 'idle';\n\n    private readonly playbackSubscribers = new Set<PlaybackListener>();\n    private readonly stateSubscribers = new Set<StateListener>();\n\n    private setState = (state: PlayerServiceInterface['state']) => {\n      this.state = state;\n      this.stateSubscribers.forEach((callback) => {\n        callback(state);\n      });\n    };\n\n    private setListener = () => {\n      sound.setProgressUpdateIntervalAsync(100);\n      sound.setOnPlaybackStatusUpdate((status) => {\n        if (status.isLoaded) {\n          if (status.didJustFinish) this.stop();\n          if (status.isPlaying) {\n            this.playbackSubscribers.forEach((callback) => {\n              callback({\n                currentTime: status.positionMillis,\n                duration: status.durationMillis ?? 0,\n                stopped: status.didJustFinish,\n              });\n            });\n          }\n        }\n      });\n    };\n\n    private removeListener = () => {\n      sound.setOnPlaybackStatusUpdate(null);\n    };\n\n    public requestPermission = async (): Promise<boolean> => {\n      const status = await avModule.Audio.getPermissionsAsync();\n      if (expoPermissionGranted([status])) {\n        return true;\n      } else {\n        const status = await avModule.Audio.requestPermissionsAsync();\n        return expoPermissionGranted([status]);\n      }\n    };\n\n    public addPlaybackListener = (callback: PlaybackListener): Unsubscribe => {\n      this.playbackSubscribers.add(callback);\n      return () => {\n        this.playbackSubscribers.delete(callback);\n      };\n    };\n\n    public addStateListener = (callback: (state: PlayerServiceInterface['state']) => void): Unsubscribe => {\n      this.stateSubscribers.add(callback);\n      return () => {\n        this.stateSubscribers.delete(callback);\n      };\n    };\n\n    private prepare = async (uri: string) => {\n      this.setState('preparing');\n      await sound.loadAsync({ uri }, { shouldPlay: false }, true);\n      this.uri = uri;\n    };\n\n    public play = async (uri: string): Promise<void> => {\n      if (matchesOneOf(this.state, ['idle', 'stopped'])) {\n        try {\n          await this.prepare(uri);\n          this.setListener();\n          await sound.playAsync();\n          this.setState('playing');\n        } catch (e) {\n          this.setState('idle');\n          this.uri = undefined;\n          this.removeListener();\n          throw e;\n        }\n      } else if (matchesOneOf(this.state, ['paused']) && this.uri === uri) {\n        try {\n          this.setListener();\n          await sound.playAsync();\n          this.setState('playing');\n        } catch (e) {\n          this.removeListener();\n          throw e;\n        }\n      }\n    };\n\n    public pause = async (): Promise<void> => {\n      if (matchesOneOf(this.state, ['playing'])) {\n        await sound.pauseAsync();\n        this.removeListener();\n        this.setState('paused');\n      }\n    };\n\n    public stop = async (): Promise<void> => {\n      if (matchesOneOf(this.state, ['playing', 'paused'])) {\n        await sound.stopAsync();\n        await sound.unloadAsync();\n        this.removeListener();\n        this.setState('stopped');\n      }\n    };\n\n    public reset = async (): Promise<void> => {\n      await this.stop();\n      this.setState('idle');\n      this.uri = undefined;\n      this.playbackSubscribers.clear();\n      this.stateSubscribers.clear();\n    };\n\n    public seek = async (time: number): Promise<void> => {\n      if (matchesOneOf(this.state, ['playing', 'paused'])) {\n        await sound.playFromPositionAsync(time);\n      }\n    };\n  }\n\n  return new VoicePlayer();\n};\n\nexport default createExpoPlayerService;\n"],"mappings":"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"}