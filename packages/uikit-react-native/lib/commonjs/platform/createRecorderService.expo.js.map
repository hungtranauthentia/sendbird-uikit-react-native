{"version":3,"names":["_reactNative","require","_uikitUtils","_VoiceMessageConfig","_interopRequireDefault","_expoPermissionGranted","obj","__esModule","default","_defineProperty","key","value","_toPropertyKey","Object","defineProperty","enumerable","configurable","writable","arg","_toPrimitive","String","input","hint","prim","Symbol","toPrimitive","undefined","res","call","TypeError","Number","createExpoRecorderService","_ref","avModule","VoiceRecorder","constructor","minDuration","VoiceMessageConfig","DEFAULT","RECORDER","MIN_DURATION","maxDuration","MAX_DURATION","extension","EXTENSION","minWaitingTime","elapsedTime","Date","now","_recordStartedAt","Audio","Recording","Set","sampleRate","SAMPLE_RATE","bitRate","BIT_RATE","numberOfChannels","CHANNELS","android","_audioSettings","options","audioEncoder","AndroidAudioEncoder","AAC","outputFormat","AndroidOutputFormat","MPEG_4","ios","IOSOutputFormat","MPEG4AAC","audioQuality","IOSAudioQuality","HIGH","web","setState","Platform","OS","setAudioModeAsync","allowsRecordingIOS","playsInSilentModeIOS","_recorder","_isDoneRecording","setProgressUpdateInterval","setOnRecordingStatusUpdate","status","completed","durationMillis","stop","isRecording","_recordingSubscribers","forEach","callback","currentTime","prepareToRecordAsync","_audioOptions","state","_stateSubscribers","getPermissionsAsync","expoPermissionGranted","requestPermissionsAsync","add","delete","matchesOneOf","prepare","startAsync","uri","getURI","e","buffer","_getRecorderStopSafeBuffer","sleep","stopAndUnloadAsync","clear","_default","exports"],"sources":["createRecorderService.expo.tsx"],"sourcesContent":["import * as ExpoAV from 'expo-av';\nimport type { RecordingOptions } from 'expo-av/build/Audio/Recording.types';\nimport { Platform } from 'react-native';\n\nimport { matchesOneOf, sleep } from '@sendbird/uikit-utils';\n\nimport VoiceMessageConfig from '../libs/VoiceMessageConfig';\nimport expoPermissionGranted from '../utils/expoPermissionGranted';\nimport type { RecorderServiceInterface, Unsubscribe } from './types';\n\ntype RecordingListener = Parameters<RecorderServiceInterface['addRecordingListener']>[number];\ntype StateListener = Parameters<RecorderServiceInterface['addStateListener']>[number];\ntype Modules = {\n  avModule: typeof ExpoAV;\n};\nconst createExpoRecorderService = ({ avModule }: Modules): RecorderServiceInterface => {\n  class VoiceRecorder implements RecorderServiceInterface {\n    public uri: RecorderServiceInterface['uri'] = undefined;\n    public state: RecorderServiceInterface['state'] = 'idle';\n    public options: RecorderServiceInterface['options'] = {\n      minDuration: VoiceMessageConfig.DEFAULT.RECORDER.MIN_DURATION,\n      maxDuration: VoiceMessageConfig.DEFAULT.RECORDER.MAX_DURATION,\n      extension: VoiceMessageConfig.DEFAULT.RECORDER.EXTENSION,\n    };\n\n    // NOTE: In Android, even when startRecorder() is awaited, if stop() is executed immediately afterward, an error occurs\n    private _recordStartedAt = 0;\n    private _getRecorderStopSafeBuffer = () => {\n      const minWaitingTime = 500;\n      const elapsedTime = Date.now() - this._recordStartedAt;\n      if (elapsedTime > minWaitingTime) return 0;\n      else return minWaitingTime - elapsedTime;\n    };\n\n    private _recorder = new avModule.Audio.Recording();\n    private readonly _recordingSubscribers = new Set<RecordingListener>();\n    private readonly _stateSubscribers = new Set<StateListener>();\n    private readonly _audioSettings = {\n      sampleRate: VoiceMessageConfig.DEFAULT.RECORDER.SAMPLE_RATE,\n      bitRate: VoiceMessageConfig.DEFAULT.RECORDER.BIT_RATE,\n      numberOfChannels: VoiceMessageConfig.DEFAULT.RECORDER.CHANNELS,\n      // encoding: mpeg4_aac\n    };\n    private readonly _audioOptions: RecordingOptions = {\n      android: {\n        ...this._audioSettings,\n        extension: `.${this.options.extension}`,\n        audioEncoder: avModule.Audio.AndroidAudioEncoder.AAC,\n        outputFormat: avModule.Audio.AndroidOutputFormat.MPEG_4,\n      },\n      ios: {\n        ...this._audioSettings,\n        extension: `.${this.options.extension}`,\n        outputFormat: avModule.Audio.IOSOutputFormat.MPEG4AAC,\n        audioQuality: avModule.Audio.IOSAudioQuality.HIGH,\n      },\n      web: {},\n    };\n\n    private prepare = async () => {\n      this.setState('preparing');\n      if (Platform.OS === 'ios') {\n        await avModule.Audio.setAudioModeAsync({ allowsRecordingIOS: true, playsInSilentModeIOS: true });\n      }\n\n      if (this._recorder._isDoneRecording) {\n        this._recorder = new avModule.Audio.Recording();\n      }\n      this._recorder.setProgressUpdateInterval(100);\n      this._recorder.setOnRecordingStatusUpdate((status) => {\n        const completed = status.durationMillis >= this.options.maxDuration;\n        if (completed) this.stop();\n        if (status.isRecording) {\n          this._recordingSubscribers.forEach((callback) => {\n            callback({ currentTime: status.durationMillis, completed: completed });\n          });\n        }\n      });\n      await this._recorder.prepareToRecordAsync(this._audioOptions);\n    };\n\n    private setState = (state: RecorderServiceInterface['state']) => {\n      this.state = state;\n      this._stateSubscribers.forEach((callback) => {\n        callback(state);\n      });\n    };\n\n    public requestPermission = async (): Promise<boolean> => {\n      const status = await avModule.Audio.getPermissionsAsync();\n      if (expoPermissionGranted([status])) {\n        return true;\n      } else {\n        const status = await avModule.Audio.requestPermissionsAsync();\n        return expoPermissionGranted([status]);\n      }\n    };\n\n    public addRecordingListener = (callback: RecordingListener): Unsubscribe => {\n      this._recordingSubscribers.add(callback);\n      return () => {\n        this._recordingSubscribers.delete(callback);\n      };\n    };\n\n    public addStateListener = (callback: StateListener): Unsubscribe => {\n      this._stateSubscribers.add(callback);\n      return () => {\n        this._stateSubscribers.delete(callback);\n      };\n    };\n\n    public record = async (): Promise<void> => {\n      if (matchesOneOf(this.state, ['idle', 'completed'])) {\n        try {\n          await this.prepare();\n          await this._recorder.startAsync();\n\n          if (Platform.OS === 'android') {\n            this._recordStartedAt = Date.now();\n          }\n\n          const uri = this._recorder.getURI();\n          if (uri) this.uri = uri;\n          this.setState('recording');\n        } catch (e) {\n          this.setState('idle');\n          throw e;\n        }\n      }\n    };\n\n    public stop = async (): Promise<void> => {\n      if (matchesOneOf(this.state, ['recording'])) {\n        if (Platform.OS === 'android') {\n          const buffer = this._getRecorderStopSafeBuffer();\n          if (buffer > 0) await sleep(buffer);\n        }\n\n        await this._recorder.stopAndUnloadAsync();\n        if (Platform.OS === 'ios') {\n          await avModule.Audio.setAudioModeAsync({ allowsRecordingIOS: false, playsInSilentModeIOS: false });\n        }\n        this.setState('completed');\n      }\n    };\n\n    public reset = async (): Promise<void> => {\n      await this.stop();\n      this.uri = undefined;\n      this._recordingSubscribers.clear();\n      this._recorder = new avModule.Audio.Recording();\n      this.setState('idle');\n    };\n  }\n\n  return new VoiceRecorder();\n};\n\nexport default createExpoRecorderService;\n"],"mappings":"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"}