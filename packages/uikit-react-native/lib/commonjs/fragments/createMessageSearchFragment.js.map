{"version":3,"names":["_react","_interopRequireWildcard","require","_message","_uikitUtils","_MessageSearchResultItem","_interopRequireDefault","_StatusComposition","_messageSearch","_useContext","obj","__esModule","default","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","getMessageSearchQuery","sdk","options","queryCreator","createMessageSearchQuery","createMessageSearchFragment","initModule","MessageSearchModule","createMessageSearchModule","_ref","onPressHeaderLeft","NOOP","channel","renderSearchResultItem","onPressSearchResultItem","padding","useSafeAreaPadding","useSendbirdChat","keyword","setKeyword","search","searchResults","loading","next","error","query","useMessageSearch","renderItem","useFreshCallback","props","createElement","Provider","Header","onChangeKeyword","onPressHeaderRight","LoadingComponent","StatusLoading","Boolean","ErrorComponent","StatusError","onPressRetry","List","messages","flatListProps","keyboardDismissMode","keyboardShouldPersistTaps","onEndReached","ListEmptyComponent","StatusEmpty","contentContainerStyle","flexGrow","_ref2","setQuery","useState","setLoading","setError","setSearchResults","queryInProgress","useRef","length","current","channelUrl","url","messageTimestampFrom","messageOffsetTimestamp","order","MessageSearchOrder","TIMESTAMP","result","err","Logger","warn","hasNext","prev","_default","exports"],"sources":["createMessageSearchFragment.tsx"],"sourcesContent":["import React, { useRef, useState } from 'react';\n\nimport { MessageSearchOrder } from '@sendbird/chat/message';\nimport {\n  Logger,\n  NOOP,\n  SendbirdBaseMessage,\n  SendbirdChatSDK,\n  SendbirdGroupChannel,\n  SendbirdMessageSearchQuery,\n  useFreshCallback,\n  useSafeAreaPadding,\n} from '@sendbird/uikit-utils';\n\nimport MessageSearchResultItem from '../components/MessageSearchResultItem';\nimport StatusComposition from '../components/StatusComposition';\nimport { createMessageSearchModule } from '../domain/messageSearch';\nimport type { MessageSearchFragment, MessageSearchModule, MessageSearchProps } from '../domain/messageSearch/types';\nimport { useSendbirdChat } from '../hooks/useContext';\n\ntype DefaultMessageSearchQueryParams = {\n  keyword: string;\n  channelUrl: string;\n  messageTimestampFrom: number;\n  order: MessageSearchOrder;\n};\n\ntype SearchQueryOptions = DefaultMessageSearchQueryParams & {\n  queryCreator?: (params: DefaultMessageSearchQueryParams) => SendbirdMessageSearchQuery;\n};\n\nfunction getMessageSearchQuery(sdk: SendbirdChatSDK, options: SearchQueryOptions) {\n  if (options.queryCreator) return options.queryCreator(options);\n  return sdk.createMessageSearchQuery(options);\n}\n\nconst createMessageSearchFragment = (initModule?: Partial<MessageSearchModule>): MessageSearchFragment => {\n  const MessageSearchModule = createMessageSearchModule(initModule);\n\n  return ({ onPressHeaderLeft = NOOP, channel, queryCreator, renderSearchResultItem, onPressSearchResultItem }) => {\n    const padding = useSafeAreaPadding(['left', 'right', 'bottom']);\n\n    const { sdk } = useSendbirdChat();\n    const { keyword, setKeyword, search, searchResults, loading, next, error, query } = useMessageSearch(sdk, {\n      channel,\n      queryCreator,\n    });\n\n    const renderItem: MessageSearchProps['List']['renderSearchResultItem'] = useFreshCallback((props) => {\n      if (renderSearchResultItem) return renderSearchResultItem(props);\n      return <MessageSearchResultItem {...props} />;\n    });\n\n    return (\n      <MessageSearchModule.Provider>\n        <MessageSearchModule.Header\n          keyword={keyword}\n          onChangeKeyword={setKeyword}\n          onPressHeaderLeft={onPressHeaderLeft}\n          onPressHeaderRight={search}\n        />\n        <StatusComposition\n          loading={loading}\n          LoadingComponent={<MessageSearchModule.StatusLoading />}\n          error={Boolean(error)}\n          ErrorComponent={<MessageSearchModule.StatusError onPressRetry={search} />}\n        >\n          {query && (\n            <MessageSearchModule.List\n              channel={channel}\n              onPressSearchResultItem={onPressSearchResultItem}\n              messages={searchResults}\n              renderSearchResultItem={renderItem}\n              flatListProps={{\n                keyboardDismissMode: 'on-drag',\n                keyboardShouldPersistTaps: 'handled',\n                onEndReached: next,\n                ListEmptyComponent: MessageSearchModule.StatusEmpty,\n                contentContainerStyle: { flexGrow: 1, ...padding },\n              }}\n            />\n          )}\n        </StatusComposition>\n      </MessageSearchModule.Provider>\n    );\n  };\n};\n\nconst useMessageSearch = (\n  sdk: SendbirdChatSDK,\n  { channel, queryCreator }: { channel: SendbirdGroupChannel; queryCreator: SearchQueryOptions['queryCreator'] },\n) => {\n  const [query, setQuery] = useState<SendbirdMessageSearchQuery>();\n  const [keyword, setKeyword] = useState('');\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState<unknown>(null);\n  const [searchResults, setSearchResults] = useState<SendbirdBaseMessage[]>([]);\n  const queryInProgress = useRef(false);\n\n  const search = useFreshCallback(async () => {\n    if (keyword.length <= 0) return;\n    if (queryInProgress.current) return;\n\n    const query = getMessageSearchQuery(sdk, {\n      keyword,\n      channelUrl: channel.url,\n      messageTimestampFrom: channel.messageOffsetTimestamp,\n      order: MessageSearchOrder.TIMESTAMP,\n      queryCreator,\n    });\n\n    setQuery(query);\n    setLoading(true);\n    setError(null);\n\n    try {\n      queryInProgress.current = true;\n      const result = await query.next();\n      setSearchResults(result);\n    } catch (err) {\n      Logger.warn('[MessageSearchFragment] search failure', err);\n      setError(err);\n    } finally {\n      queryInProgress.current = false;\n      setLoading(false);\n    }\n  });\n\n  const next = useFreshCallback(async () => {\n    if (!query?.hasNext) return;\n    if (queryInProgress.current) return;\n\n    try {\n      queryInProgress.current = true;\n      const result = await query.next();\n      setSearchResults((prev) => [...prev, ...result]);\n    } catch (err) {\n      Logger.warn('[MessageSearchFragment] next failure', err);\n      setError(err);\n    } finally {\n      queryInProgress.current = false;\n    }\n  });\n\n  return {\n    keyword,\n    setKeyword,\n\n    query,\n    loading,\n    error,\n    searchResults,\n\n    search,\n    next,\n  };\n};\n\nexport default createMessageSearchFragment;\n"],"mappings":"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"}